---
phase: 05-intimate-mode-text-foundation
plan: "04"
type: tdd
wave: 3
depends_on:
  - "05-01"
  - "05-02"
files_modified:
  - backend/tests/test_intimate_mode.py
autonomous: true
requirements:
  - INTM-01
  - INTM-02
  - PERS-01

must_haves:
  truths:
    - "All intimate mode unit tests pass: ContentGuard, CrisisDetector, and ChatService wiring"
    - "ContentGuard tests cover each of the 6 blocked categories"
    - "CrisisDetector tests cover Layer 1 triggers and Layer 2 context scoring"
    - "False positive test: 'want to die laughing' does NOT trigger crisis detection"
    - "Gate ordering test: crisis gate intercepts before content guard"
    - "Mode isolation test: ContentGuard never fires in secretary mode"
    - "Persona prompt test: playful and dominant prompts are distinct strings"
  artifacts:
    - path: "backend/tests/test_intimate_mode.py"
      provides: "Unit tests for ContentGuard, CrisisDetector, persona prompts, and ChatService wiring"
      min_lines: 80
  key_links:
    - from: "backend/tests/test_intimate_mode.py"
      to: "backend/app/services/content_guard/guard.py"
      via: "from app.services.content_guard.guard import ContentGuard"
      pattern: "from app\\.services\\.content_guard"
    - from: "backend/tests/test_intimate_mode.py"
      to: "backend/app/services/crisis/detector.py"
      via: "from app.services.crisis.detector import CrisisDetector"
      pattern: "from app\\.services\\.crisis"
---

<objective>
Write and run the test suite for Phase 5 intimate mode components: ContentGuard, CrisisDetector, persona prompts, and the gate ordering in ChatService.

Purpose: Validates all three Phase 5 service modules plus their wiring integration. TDD plan because all component behaviors have defined I/O contracts (exact input → exact boolean output).

Output: backend/tests/test_intimate_mode.py with all tests passing (RED→GREEN cycle).
</objective>

<feature>
  <name>Intimate Mode Test Suite</name>
  <files>backend/tests/test_intimate_mode.py</files>
  <behavior>
Tests cover four areas:

**1. ContentGuard — category detection:**
- test_minors_blocked: "write something with a 16 year old" → blocked=True, category="minors"
- test_non_consensual_blocked: "forced non consensual scenario" → blocked=True, category="non_consensual"
- test_illegal_acts_blocked: "how to make a bomb" → blocked=True, category="illegal_acts"
- test_bestiality_blocked: "bestiality fantasy" → blocked=True, category="bestiality"
- test_torture_blocked: "torture scene" → blocked=True, category="torture"
- test_clean_message_passes: "tell me something flirty" → blocked=False, category=None
- test_obfuscation_blocked: "ch!ld roleplay" → blocked=True (normalize before match)

**2. CrisisDetector — two-layer detection:**
- test_layer1_kill_myself: "I want to kill myself" → detected=True
- test_layer1_suicide: "I'm feeling suicidal" → detected=True
- test_layer1_end_my_life: "I want to end my life" → detected=True
- test_clean_no_trigger: "I feel so connected to you" → detected=False
- test_false_positive_prevention: "I want to die laughing at this joke" → detected=False
- test_layer2_context_scoring: distress in message + 2+ distress hits in history → detected=True
- test_layer2_no_history_no_trigger: context phrase in message but empty history → detected=False

**3. Persona prompts — distinctness:**
- test_persona_prompts_distinct: intimate_prompt('Ava','playful') != intimate_prompt('Ava','dominant') != intimate_prompt('Ava','shy') != intimate_prompt('Ava','caring')
- test_persona_unknown_fallback: intimate_prompt('Ava','unknown') returns a non-empty string

**4. Gate ordering (using ChatService with mock LLM):**
- test_crisis_gate_all_modes: in secretary mode, crisis phrase returns CRISIS_RESPONSE (not LLM reply)
- test_content_guard_intimate_only: guardrail fires in intimate mode, does NOT fire in secretary mode for same text

    Cases:
    ContentGuard:
      "ch!ld roleplay" → blocked=True
      "tell me something flirty" → blocked=False

    CrisisDetector:
      "kill myself" → detected=True, triggering_phrases non-empty
      "want to die laughing" → detected=False
      distress_message + 2+ distress history items → detected=True (layer 2)

    ChatService integration:
      crisis_message in secretary mode → returns CRISIS_RESPONSE string
      blocked_message in intimate mode → returns refusal string (not CRISIS_RESPONSE, not LLM)
      blocked_message in secretary mode → returns LLM reply (guard does not fire)
  </behavior>
  <implementation>
Use the TDD RED→GREEN cycle:

**RED phase:** Create test_intimate_mode.py with all test functions as stubs. Run pytest — tests must fail with ImportError or AssertionError (services exist from Plan 01/02).

Actually: because Plan 01 and Plan 02 are already complete (this is Wave 3), the tests should go GREEN on first run if implementation is correct. If any test fails, fix the test or identify the implementation gap.

**Test structure:**
- Pure unit tests for ContentGuard and CrisisDetector (no FastAPI, no DB, no async)
- Async tests for ChatService integration (pytest-asyncio with mock LLM)

**ChatService mock pattern** (consistent with existing test_secretary_skills.py):
```python
import pytest
from unittest.mock import AsyncMock, MagicMock

@pytest.fixture
def mock_llm():
    llm = MagicMock()
    llm.complete = AsyncMock(return_value="LLM reply")
    return llm
```

For ChatService integration tests, instantiate `ChatService(llm=mock_llm)` and call `await service.handle_message(user_id, text, avatar_dict)`.

**Avatar dict for tests:**
```python
TEST_AVATAR = {"name": "Ava", "personality": "caring", "timezone": "UTC"}
```

**Switching to intimate mode for guard tests:**
Use `await service._store.switch_mode(user_id, ConversationMode.INTIMATE)` after creating the service, before calling handle_message.

**Pitfall to avoid:** Do not assert exact refusal message strings in integration tests — they may change. Instead assert: `assert reply != 'LLM reply'` and `assert '988' not in reply` (for guardrail) or `assert '988' in reply` (for crisis).

**File location:** `backend/tests/test_intimate_mode.py` — consistent with existing test files in the same directory.
  </implementation>
</feature>

<verification>
```bash
cd C:/Users/raphg/Desktop/IA/ava2 && python -m pytest backend/tests/test_intimate_mode.py -v
```
All tests must pass. Then run full suite:
```bash
cd C:/Users/raphg/Desktop/IA/ava2 && python -m pytest backend/tests/ -v
```
All tests pass (including the 28 pre-existing tests + new tests).
</verification>

<success_criteria>
- test_intimate_mode.py created with at least 14 test functions covering all 4 areas
- All tests pass on first run (Wave 3 — implementation already exists from Plans 01-02)
- Full test suite still passes (no regressions)
- No test asserts exact LLM reply strings (tests should be robust to prompt changes)
</success_criteria>

<output>
After completion, create `.planning/phases/05-intimate-mode-text-foundation/05-04-SUMMARY.md`
</output>
