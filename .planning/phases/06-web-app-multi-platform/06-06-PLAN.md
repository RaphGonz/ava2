---
phase: 06-web-app-multi-platform
plan: 06
type: execute
wave: 4
depends_on:
  - "06-03"
  - "06-04"
  - "06-05"
autonomous: false
files_modified: []
requirements:
  - PLAT-02
  - PLAT-03
  - PLAT-04
  - PLAT-05

must_haves:
  truths:
    - "User can sign in on the web app and see the chat interface"
    - "User can send a message on the web app and receive Ava's reply"
    - "User can change settings (platform preference, spiciness, mode-switch phrase) and they persist"
    - "PlatformAdapter Protocol satisfies isinstance() check for both adapters"
    - "Web messages are stored with channel='web', not 'whatsapp'"
    - "platform_router returns in-character redirect when user's preferred_platform != incoming_platform"
    - "NSFW photo signed-URL endpoint returns a 24h signed URL (tested manually)"
  artifacts:
    - path: "backend/app/adapters/base.py"
      provides: "PlatformAdapter Protocol"
    - path: "backend/app/services/platform_router.py"
      provides: "route() function"
    - path: "backend/app/routers/web_chat.py"
      provides: "POST /chat and GET /chat/history"
    - path: "frontend/src/pages/ChatPage.tsx"
      provides: "Working web chat interface"
    - path: "frontend/src/pages/SettingsPage.tsx"
      provides: "Working settings panel"
  key_links:
    - from: "frontend/src/pages/ChatPage.tsx"
      to: "POST /chat"
      via: "useSendMessage() mutation"
      pattern: "useSendMessage"
    - from: "backend/app/services/platform_router.py"
      to: "backend/app/services/chat.py"
      via: "chat_service.handle_message()"
      pattern: "handle_message"
---

<objective>
Human verification of the complete Phase 6 web app and platform adapter system.

Purpose: Confirm the full stack works end-to-end before marking Phase 6 complete. Automated tests verify backend structure; human verification confirms the UX, visual layout, and live data flow.
Output: Approved Phase 6 system or a list of issues to address.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Automated end-to-end verification</name>
  <files></files>
  <action>
Run all automated checks before the human checkpoint.

**1. Backend tests:**
```bash
cd backend && python -m pytest tests/ -x -q
```
All 47+ existing tests must pass.

**2. Backend import checks:**
```bash
cd backend && python -c "
from app.adapters.base import PlatformAdapter, NormalizedMessage
from app.adapters.whatsapp_adapter import WhatsAppAdapter
from app.adapters.web_adapter import WebAdapter
from app.services.platform_router import route
from app.routers.web_chat import router as web_chat_router
from app.routers.photo import router as photo_router

# Structural Protocol check
wa = WhatsAppAdapter.__new__(WhatsAppAdapter)
web = WebAdapter.__new__(WebAdapter)
assert isinstance(wa, PlatformAdapter), 'WhatsAppAdapter not Protocol-compliant'
assert isinstance(web, PlatformAdapter), 'WebAdapter not Protocol-compliant'

# Route registration check
routes = [r.path for r in web_chat_router.routes]
print('web_chat routes:', routes)
assert any('/chat' in str(r) for r in routes), 'POST /chat route missing'

# photo router
photo_routes = [r.path for r in photo_router.routes]
print('photo routes:', photo_routes)
assert any('signed-url' in str(r) for r in photo_routes), 'signed-url route missing'

print('All automated checks passed')
"
```

**3. Frontend build:**
```bash
cd frontend && npm run build
```
Must complete with zero TypeScript errors.

**4. Migration SQL check:**
```bash
python -c "
with open('backend/migrations/003_phase6_preferences.sql') as f:
    sql = f.read()
required = ['preferred_platform', 'spiciness_level', 'mode_switch_phrase', 'notif_prefs', 'web']
missing = [r for r in required if r not in sql]
if missing:
    print('MISSING from migration:', missing)
    exit(1)
print('Migration SQL OK')
"
```

**5. ChatService extension check:**
```bash
cd backend && python -c "
import inspect
from app.services.chat import ChatService
from app.services.llm.prompts import intimate_prompt
src = inspect.getsource(ChatService.handle_message)
assert 'mode_switch_phrase' in src, 'mode_switch_phrase missing'
assert 'spiciness_level' in src, 'spiciness_level missing'
sig = inspect.signature(intimate_prompt)
assert 'spiciness_level' in sig.parameters, 'spiciness_level param missing from intimate_prompt'
print('ChatService extensions OK')
"
```

Report all results. If any check fails, fix it before proceeding to the human checkpoint.
  </action>
  <verify>
    <automated>cd /c/Users/raphg/Desktop/IA/ava2/backend && python -m pytest tests/ -x -q 2>&1 | tail -5</automated>
  </verify>
  <done>All 5 automated checks pass with no failures.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification â€” Phase 6 web app and platform adapter</name>
  <what-built>
Complete Phase 6 web app and platform adapter system:

1. DB migration (003_phase6_preferences.sql) â€” extends user_preferences with preferred_platform, spiciness_level, mode_switch_phrase, notif_prefs; extends message_channel enum to include 'web'
2. Platform adapter layer (PlatformAdapter Protocol, NormalizedMessage, WhatsAppAdapter, WebAdapter, platform_router.py)
3. Web chat API (POST /chat, GET /chat/history) + preferences PATCH + photo signed-URL endpoint
4. ChatService extensions (mode_switch_phrase priority check, spiciness_level ceiling)
5. React web app with LoginPage, ChatPage (bubble layout), SettingsPage (all 5 settings sections), PhotoPage

Apply the DB migration to Supabase before starting the live tests.
  </what-built>
  <how-to-verify>
**Setup (do first):**
1. Apply the migration: paste `backend/migrations/003_phase6_preferences.sql` into Supabase Dashboard SQL Editor â†’ Run
2. Start the backend: `cd backend && uvicorn app.main:app --reload`
3. Start the frontend: `cd frontend && npm run dev`

**Test 1 â€” Web app auth flow:**
1. Open http://localhost:3000
2. Should redirect to http://localhost:3000/login
3. Sign in with an existing test account (email + password from earlier phases)
4. Should redirect to http://localhost:3000/chat

Expected: Chat page renders with header "Ava" and "Your AI companion", empty message area with "Say hello to Ava ðŸ‘‹", input field, Send button.

**Test 2 â€” Web chat message round-trip:**
1. Type a message in the chat input, press Enter or click Send
2. Message should appear as a right-aligned dark bubble immediately
3. Ava's reply should appear as a left-aligned gray bubble after a few seconds

Expected: Both bubbles appear, reply is contextually appropriate (Ava's persona).

**Test 3 â€” Settings page:**
1. Click "Settings" in the header
2. Should navigate to http://localhost:3000/settings
3. Verify all sections present: Ava's Persona (6 options), Preferred Platform (WhatsApp/Web App toggle), Content Ceiling (Mild/Spicy/Explicit), Mode-Switch Phrase (text input), WhatsApp Notifications (checkbox), Save button

Change platform preference to "Web App", click Save.
Expected: "Settings saved" confirmation appears.

**Test 4 â€” Preferred platform redirect:**
Set preferred_platform to "web" via Settings (already done in Test 3).
Send a WhatsApp message from your linked phone to the bot.
Expected: Bot responds with the in-character redirect message ("Hey ðŸ˜Š I mostly hang out on the web app â€” come find me there! (You can change this in settings)").

**Test 5 â€” Web history channel isolation:**
In Supabase Dashboard â†’ Table Editor â†’ messages table.
Filter by your user_id. Verify that messages sent via the web app have `channel = 'web'`.
WhatsApp messages (if any) have `channel = 'whatsapp'`.

**Test 6 â€” Platform adapter Protocol check (optional, automated):**
Run: `cd backend && python -c "from app.adapters.base import PlatformAdapter; from app.adapters.whatsapp_adapter import WhatsAppAdapter; wa = WhatsAppAdapter.__new__(WhatsAppAdapter); print(isinstance(wa, PlatformAdapter))"`
Expected: `True`

**Test 7 â€” Photo signed-URL endpoint (backend only, no real photo yet):**
Use curl or the Supabase Dashboard to confirm the endpoint is reachable:
`curl -X POST http://localhost:8000/photos/signed-url -H "Authorization: Bearer YOUR_TOKEN" -H "Content-Type: application/json" -d '{"photo_path": "test/test.jpg"}'`
Expected: Returns 500 (bucket doesn't exist yet â€” that's OK for Phase 6) or a signed URL if the bucket was created. The important thing is the endpoint is registered and auth is working (not 404).
  </how-to-verify>
  <resume-signal>
Type "approved" if all tests pass, or describe any issues found.
  </resume-signal>
  <action>
Run the 7 verification tests described in how-to-verify above. Start backend and frontend dev servers, apply the DB migration, then walk through each test scenario.
  </action>
  <verify>
    <manual>All 7 test scenarios produce expected outcomes as described in how-to-verify.</manual>
  </verify>
  <done>User types "approved" â€” Phase 6 is complete and ready for Phase 7.</done>
</task>

</tasks>

<verification>
All 5 automated checks pass before the human checkpoint.
Human approves the live system after testing all 7 scenarios above.
</verification>

<success_criteria>
- All 47+ existing pytest tests pass
- PlatformAdapter Protocol isinstance() check returns True for both adapters
- Frontend builds without TypeScript errors
- User can sign in, send messages, and receive replies on the web app
- Settings save and persist (confirmed via Supabase table)
- Web messages appear with channel='web' in messages table
- Platform redirect fires when preferred_platform doesn't match incoming platform
</success_criteria>

<output>
After completion, create `.planning/phases/06-web-app-multi-platform/06-06-SUMMARY.md` summarizing:
- Verification results (which tests passed/failed)
- Any issues found and fixed during verification
- Phase 6 completion status
- Notes for Phase 7 (what the photo delivery endpoint expects)
</output>
