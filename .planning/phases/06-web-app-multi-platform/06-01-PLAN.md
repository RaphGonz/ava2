---
phase: 06-web-app-multi-platform
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/migrations/003_phase6_preferences.sql
autonomous: true
requirements:
  - PLAT-02
  - PLAT-04
  - PLAT-05

must_haves:
  truths:
    - "user_preferences table has preferred_platform, spiciness_level, mode_switch_phrase, notif_prefs columns"
    - "messages table message_channel enum includes 'web' alongside 'whatsapp'"
    - "Constraints on preferred_platform ('whatsapp'|'web') and spiciness_level ('mild'|'spicy'|'explicit') are enforced at DB level"
  artifacts:
    - path: "backend/migrations/003_phase6_preferences.sql"
      provides: "Phase 6 DB migration: new user_preferences columns + message_channel 'web' value"
      min_lines: 30
  key_links:
    - from: "backend/migrations/003_phase6_preferences.sql"
      to: "public.user_preferences"
      via: "ALTER TABLE ADD COLUMN IF NOT EXISTS"
      pattern: "ADD COLUMN IF NOT EXISTS preferred_platform"
---

<objective>
Create the Phase 6 database migration that adds four new columns to user_preferences and extends the message_channel enum to include 'web'.

Purpose: All Phase 6 backend features (platform preference, spiciness ceiling, custom mode-switch phrase, web chat channel) depend on these schema additions. This is the critical-path foundation task.
Output: backend/migrations/003_phase6_preferences.sql — ready to apply to Supabase.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

Prior schema to understand:
@backend/migrations/001_initial_schema.sql
@backend/migrations/002_google_calendar_tokens.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write Phase 6 DB migration SQL</name>
  <files>backend/migrations/003_phase6_preferences.sql</files>
  <action>
Create `backend/migrations/003_phase6_preferences.sql` as a single atomic transaction (BEGIN/COMMIT).

The migration must do the following in order:

1. **Extend the message_channel enum to add 'web':**
   The existing enum in 001_initial_schema.sql has values ('app', 'whatsapp'). PostgreSQL does not support `ADD VALUE` inside a transaction for older Postgres, but Supabase runs Postgres 15+ which supports it. Use:
   ```sql
   ALTER TYPE message_channel ADD VALUE IF NOT EXISTS 'web';
   ```
   IMPORTANT: `ALTER TYPE ADD VALUE` cannot run inside a transaction block in PostgreSQL. Place this statement BEFORE the BEGIN block.

2. **Add new columns to user_preferences (inside BEGIN/COMMIT):**
   ```sql
   ALTER TABLE public.user_preferences
     ADD COLUMN IF NOT EXISTS preferred_platform  TEXT DEFAULT 'whatsapp',
     ADD COLUMN IF NOT EXISTS spiciness_level     TEXT DEFAULT 'mild',
     ADD COLUMN IF NOT EXISTS mode_switch_phrase  TEXT,
     ADD COLUMN IF NOT EXISTS notif_prefs         JSONB DEFAULT '{}';
   ```

3. **Add CHECK constraints:**
   ```sql
   ALTER TABLE public.user_preferences
     ADD CONSTRAINT chk_preferred_platform
     CHECK (preferred_platform IN ('whatsapp', 'web'));

   ALTER TABLE public.user_preferences
     ADD CONSTRAINT chk_spiciness_level
     CHECK (spiciness_level IN ('mild', 'spicy', 'explicit'));
   ```
   Use `IF NOT EXISTS` pattern for the constraints if possible, or add a guard:
   ```sql
   DO $$ BEGIN
     ALTER TABLE public.user_preferences ADD CONSTRAINT chk_preferred_platform ...;
   EXCEPTION WHEN duplicate_object THEN NULL;
   END $$;
   ```

4. **Add a performance index** on preferred_platform for the platform_router.py lookup:
   ```sql
   CREATE INDEX IF NOT EXISTS idx_user_preferences_preferred_platform
     ON public.user_preferences (user_id, preferred_platform);
   ```

File header comment must document:
- Migration number and date (003, 2026-02-24)
- Phase: 06-web-app-multi-platform
- What changes: columns added, enum extended
- How to apply (same instructions as 001: Supabase Dashboard SQL Editor or psql)

Column semantics to document in SQL comments:
- preferred_platform: 'whatsapp' | 'web' — which platform Ava replies on; defaults to whatsapp
- spiciness_level: 'mild' | 'spicy' | 'explicit' — content ceiling Ava will not exceed
- mode_switch_phrase: nullable TEXT — user-configurable phrase to switch modes; NULL means use system defaults
- notif_prefs: JSONB flexible map for notification preferences (WhatsApp on/off, frequency, etc.)
  </action>
  <verify>
    <automated>cd /c/Users/raphg/Desktop/IA/ava2 && python -c "
import re, sys
with open('backend/migrations/003_phase6_preferences.sql') as f:
    sql = f.read()
checks = [
    ('preferred_platform column', 'preferred_platform'),
    ('spiciness_level column', 'spiciness_level'),
    ('mode_switch_phrase column', 'mode_switch_phrase'),
    ('notif_prefs column', 'notif_prefs'),
    ('web enum value', \"ADD VALUE IF NOT EXISTS 'web'\"),
    ('platform constraint', 'chk_preferred_platform'),
    ('spiciness constraint', 'chk_spiciness_level'),
]
failed = [(name, term) for name, term in checks if term not in sql]
if failed:
    print('MISSING:', failed)
    sys.exit(1)
print('All checks passed')
"
    </automated>
    <manual>Review SQL for correctness: ALTER TYPE must be outside transaction, constraints use DO $$ guard.</manual>
  </verify>
  <done>
    003_phase6_preferences.sql exists, passes the Python content check, and is ready to apply to Supabase. The ALTER TYPE statement is outside the BEGIN block. All four columns are added with IF NOT EXISTS. CHECK constraints are guarded against duplicate-object errors.
  </done>
</task>

</tasks>

<verification>
Run: `python -c "open('backend/migrations/003_phase6_preferences.sql').read()"` to confirm file exists.
Run the automated verify command from Task 1 to confirm all required SQL elements are present.
</verification>

<success_criteria>
- 003_phase6_preferences.sql exists in backend/migrations/
- File contains ALTER TYPE message_channel ADD VALUE IF NOT EXISTS 'web' (outside transaction)
- File adds preferred_platform, spiciness_level, mode_switch_phrase, notif_prefs columns with IF NOT EXISTS
- File has CHECK constraints for preferred_platform and spiciness_level
- File follows the same documentation conventions as 001_initial_schema.sql
</success_criteria>

<output>
After completion, create `.planning/phases/06-web-app-multi-platform/06-01-SUMMARY.md` summarizing:
- What was created (migration file path)
- Column names and their defaults
- Constraints added
- The ALTER TYPE statement placement note (outside transaction)
- Any deviations from the plan
</output>
