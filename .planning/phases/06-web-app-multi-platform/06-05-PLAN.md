---
phase: 06-web-app-multi-platform
plan: 05
type: execute
wave: 3
depends_on:
  - "06-02"
  - "06-04"
files_modified:
  - frontend/src/pages/ChatPage.tsx
  - frontend/src/components/ChatBubble.tsx
  - frontend/src/components/MessageList.tsx
  - frontend/src/components/ChatInput.tsx
  - frontend/src/pages/SettingsPage.tsx
  - frontend/src/pages/PhotoPage.tsx
autonomous: true
requirements:
  - PLAT-02
  - PLAT-04

must_haves:
  truths:
    - "ChatPage renders message bubbles with user messages right-aligned and Ava messages left-aligned"
    - "User can type a message and submit it; reply appears after the round-trip to POST /chat"
    - "Message history loads from GET /chat/history on page mount"
    - "SettingsPage shows platform toggle (WhatsApp/web), spiciness slider (3 tiers), mode-switch phrase input, and save button"
    - "Settings save calls PATCH /preferences/ and shows success feedback"
    - "PhotoPage renders the photo from the signed URL (passed via query param) embedded in the web app chrome"
    - "Navigation links connect ChatPage and SettingsPage"
  artifacts:
    - path: "frontend/src/pages/ChatPage.tsx"
      provides: "Full chat interface with message list, input, and send mutation"
      min_lines: 60
    - path: "frontend/src/components/ChatBubble.tsx"
      provides: "Single message bubble with role-based alignment"
      min_lines: 15
    - path: "frontend/src/components/MessageList.tsx"
      provides: "Scrollable message list rendering ChatBubble for each message"
      min_lines: 20
    - path: "frontend/src/components/ChatInput.tsx"
      provides: "Text input with send button, submit on Enter"
      min_lines: 20
    - path: "frontend/src/pages/SettingsPage.tsx"
      provides: "Settings form with platform preference, spiciness, mode-switch phrase"
      min_lines: 80
    - path: "frontend/src/pages/PhotoPage.tsx"
      provides: "Photo viewer that renders image from ?url= query param in web app chrome"
      min_lines: 20
  key_links:
    - from: "frontend/src/pages/ChatPage.tsx"
      to: "frontend/src/api/chat.ts"
      via: "useChatHistory() and useSendMessage() hooks"
      pattern: "useChatHistory|useSendMessage"
    - from: "frontend/src/pages/SettingsPage.tsx"
      to: "frontend/src/api/preferences.ts"
      via: "getPreferences() and updatePreferences() calls"
      pattern: "updatePreferences"
    - from: "frontend/src/pages/PhotoPage.tsx"
      to: "query param url"
      via: "useSearchParams() reading ?url="
      pattern: "useSearchParams"
---

<objective>
Build the full frontend UI: ChatPage with chat bubble layout, reusable chat components, SettingsPage with all Phase 6 settings controls, and PhotoPage for viewing signed photo URLs.

Purpose: This is the visible product of Phase 6 ‚Äî the web interface users interact with. The chat must feel like a messaging app (familiar bubble layout). Settings must expose persona, spiciness ceiling, mode-switch phrase, and platform preference.
Output: Complete frontend UI across three pages and shared components.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/06-web-app-multi-platform/06-CONTEXT.md
@.planning/phases/06-web-app-multi-platform/06-02-SUMMARY.md
@.planning/phases/06-web-app-multi-platform/06-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Chat components and ChatPage</name>
  <files>
    frontend/src/components/ChatBubble.tsx
    frontend/src/components/MessageList.tsx
    frontend/src/components/ChatInput.tsx
    frontend/src/pages/ChatPage.tsx
  </files>
  <action>
**frontend/src/components/ChatBubble.tsx:**
```tsx
interface ChatBubbleProps {
  role: 'user' | 'assistant'
  content: string
  timestamp?: string
}

export default function ChatBubble({ role, content, timestamp }: ChatBubbleProps) {
  const isUser = role === 'user'
  return (
    <div className={`flex ${isUser ? 'justify-end' : 'justify-start'} mb-2`}>
      <div
        className={`max-w-[75%] px-4 py-2 rounded-2xl text-sm leading-relaxed ${
          isUser
            ? 'bg-gray-900 text-white rounded-br-sm'
            : 'bg-gray-100 text-gray-900 rounded-bl-sm'
        }`}
      >
        {content}
        {timestamp && (
          <p className={`text-xs mt-1 ${isUser ? 'text-gray-400' : 'text-gray-400'}`}>
            {new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
          </p>
        )}
      </div>
    </div>
  )
}
```

**frontend/src/components/MessageList.tsx:**
```tsx
import { useEffect, useRef } from 'react'
import ChatBubble from './ChatBubble'
import type { ChatMessage } from '../api/chat'

interface MessageListProps {
  messages: ChatMessage[]
  isLoading: boolean
}

export default function MessageList({ messages, isLoading }: MessageListProps) {
  const bottomRef = useRef<HTMLDivElement>(null)

  // Auto-scroll to bottom when new messages arrive
  useEffect(() => {
    bottomRef.current?.scrollIntoView({ behavior: 'smooth' })
  }, [messages])

  if (isLoading && messages.length === 0) {
    return (
      <div className="flex-1 flex items-center justify-center text-gray-400 text-sm">
        Loading...
      </div>
    )
  }

  return (
    <div className="flex-1 overflow-y-auto px-4 py-4 space-y-1">
      {messages.length === 0 && (
        <p className="text-center text-gray-400 text-sm mt-8">
          Say hello to Ava üëã
        </p>
      )}
      {messages.map(msg => (
        <ChatBubble
          key={msg.id}
          role={msg.role}
          content={msg.content}
          timestamp={msg.created_at}
        />
      ))}
      <div ref={bottomRef} />
    </div>
  )
}
```

**frontend/src/components/ChatInput.tsx:**
```tsx
import { useState } from 'react'

interface ChatInputProps {
  onSend: (text: string) => void
  disabled?: boolean
}

export default function ChatInput({ onSend, disabled }: ChatInputProps) {
  const [text, setText] = useState('')

  function handleSubmit(e: React.FormEvent) {
    e.preventDefault()
    const trimmed = text.trim()
    if (!trimmed) return
    onSend(trimmed)
    setText('')
  }

  function handleKeyDown(e: React.KeyboardEvent<HTMLTextAreaElement>) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault()
      handleSubmit(e as unknown as React.FormEvent)
    }
  }

  return (
    <form onSubmit={handleSubmit} className="border-t border-gray-100 px-4 py-3 bg-white">
      <div className="flex items-end gap-2">
        <textarea
          value={text}
          onChange={e => setText(e.target.value)}
          onKeyDown={handleKeyDown}
          disabled={disabled}
          placeholder="Message Ava..."
          rows={1}
          className="flex-1 resize-none border border-gray-200 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gray-900 disabled:opacity-50 max-h-32 overflow-y-auto"
          style={{ minHeight: '38px' }}
        />
        <button
          type="submit"
          disabled={disabled || !text.trim()}
          className="bg-gray-900 text-white rounded-xl px-4 py-2 text-sm font-medium hover:bg-gray-700 disabled:opacity-40 transition-colors flex-shrink-0"
        >
          Send
        </button>
      </div>
    </form>
  )
}
```

**frontend/src/pages/ChatPage.tsx:**
```tsx
import { useNavigate } from 'react-router-dom'
import { useAuthStore } from '../store/useAuthStore'
import { useChatHistory, useSendMessage } from '../api/chat'
import MessageList from '../components/MessageList'
import ChatInput from '../components/ChatInput'

export default function ChatPage() {
  const token = useAuthStore(s => s.token)
  const clearAuth = useAuthStore(s => s.clearAuth)
  const navigate = useNavigate()

  const { data: messages = [], isLoading } = useChatHistory(token)
  const sendMutation = useSendMessage(token)

  function handleSend(text: string) {
    sendMutation.mutate(text)
  }

  function handleSignOut() {
    clearAuth()
    navigate('/login')
  }

  return (
    <div className="h-screen flex flex-col bg-white max-w-2xl mx-auto">
      {/* Header */}
      <div className="flex items-center justify-between px-4 py-3 border-b border-gray-100">
        <div className="flex items-center gap-3">
          <div className="w-8 h-8 rounded-full bg-gray-900 flex items-center justify-center text-white text-xs font-semibold">
            A
          </div>
          <div>
            <p className="text-sm font-semibold text-gray-900">Ava</p>
            <p className="text-xs text-gray-400">Your AI companion</p>
          </div>
        </div>
        <div className="flex items-center gap-2">
          <button
            onClick={() => navigate('/settings')}
            className="text-gray-400 hover:text-gray-700 text-sm px-2 py-1 rounded transition-colors"
          >
            Settings
          </button>
          <button
            onClick={handleSignOut}
            className="text-gray-400 hover:text-gray-700 text-sm px-2 py-1 rounded transition-colors"
          >
            Sign out
          </button>
        </div>
      </div>

      {/* Messages */}
      <MessageList messages={messages} isLoading={isLoading} />

      {/* Input */}
      <ChatInput onSend={handleSend} disabled={sendMutation.isPending} />
    </div>
  )
}
```
  </action>
  <verify>
    <automated>cd /c/Users/raphg/Desktop/IA/ava2/frontend && npm run build 2>&1 | tail -10</automated>
    <manual>Confirm build passes with no TypeScript errors in new component files.</manual>
  </verify>
  <done>
    ChatBubble, MessageList, ChatInput components exist. ChatPage renders the full chat interface with header, message list, and input. `npm run build` passes with no errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: SettingsPage and PhotoPage</name>
  <files>
    frontend/src/pages/SettingsPage.tsx
    frontend/src/pages/PhotoPage.tsx
  </files>
  <action>
**frontend/src/pages/SettingsPage.tsx:**
```tsx
import { useState, useEffect } from 'react'
import { useNavigate } from 'react-router-dom'
import { useAuthStore } from '../store/useAuthStore'
import { getPreferences, updatePreferences, type Preferences } from '../api/preferences'

const SPICINESS_OPTIONS = [
  { value: 'mild', label: 'Mild', description: 'Flirty and playful, nothing explicit' },
  { value: 'spicy', label: 'Spicy', description: 'Suggestive and sensual' },
  { value: 'explicit', label: 'Explicit', description: 'Fully adult content' },
] as const

const PERSONA_OPTIONS = [
  { value: 'playful', label: 'Playful' },
  { value: 'dominant', label: 'Dominant' },
  { value: 'shy', label: 'Shy' },
  { value: 'caring', label: 'Caring' },
  { value: 'intellectual', label: 'Intellectual' },
  { value: 'adventurous', label: 'Adventurous' },
] as const

export default function SettingsPage() {
  const token = useAuthStore(s => s.token)
  const navigate = useNavigate()

  const [prefs, setPrefs] = useState<Preferences>({})
  const [loading, setLoading] = useState(true)
  const [saving, setSaving] = useState(false)
  const [saved, setSaved] = useState(false)
  const [error, setError] = useState<string | null>(null)

  useEffect(() => {
    if (!token) return
    getPreferences(token)
      .then(setPrefs)
      .catch(e => setError(e.message))
      .finally(() => setLoading(false))
  }, [token])

  async function handleSave() {
    if (!token) return
    setSaving(true)
    setError(null)
    try {
      await updatePreferences(token, {
        preferred_platform: prefs.preferred_platform,
        spiciness_level: prefs.spiciness_level,
        mode_switch_phrase: prefs.mode_switch_phrase ?? undefined,
        notif_prefs: prefs.notif_prefs,
      })
      setSaved(true)
      setTimeout(() => setSaved(false), 2000)
    } catch (e) {
      setError(e instanceof Error ? e.message : 'Save failed')
    } finally {
      setSaving(false)
    }
  }

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <p className="text-gray-400 text-sm">Loading settings...</p>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gray-50">
      <div className="max-w-lg mx-auto px-4 py-8">
        {/* Header */}
        <div className="flex items-center gap-3 mb-8">
          <button
            onClick={() => navigate('/chat')}
            className="text-gray-400 hover:text-gray-700 transition-colors"
            aria-label="Back to chat"
          >
            ‚Üê Back
          </button>
          <h1 className="text-xl font-semibold text-gray-900">Settings</h1>
        </div>

        <div className="space-y-6">
          {/* Platform Preference */}
          <section className="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
            <h2 className="text-sm font-semibold text-gray-900 mb-1">Preferred Platform</h2>
            <p className="text-xs text-gray-500 mb-4">Ava will only reply on your preferred platform</p>
            <div className="flex gap-3">
              {(['whatsapp', 'web'] as const).map(platform => (
                <button
                  key={platform}
                  onClick={() => setPrefs(p => ({ ...p, preferred_platform: platform }))}
                  className={`flex-1 py-2 px-4 rounded-xl text-sm font-medium border transition-colors ${
                    prefs.preferred_platform === platform
                      ? 'bg-gray-900 text-white border-gray-900'
                      : 'bg-white text-gray-700 border-gray-200 hover:border-gray-400'
                  }`}
                >
                  {platform === 'whatsapp' ? 'WhatsApp' : 'Web App'}
                </button>
              ))}
            </div>
          </section>

          {/* Spiciness Ceiling */}
          <section className="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
            <h2 className="text-sm font-semibold text-gray-900 mb-1">Content Ceiling</h2>
            <p className="text-xs text-gray-500 mb-4">Ava will not escalate beyond this level</p>
            <div className="space-y-2">
              {SPICINESS_OPTIONS.map(opt => (
                <button
                  key={opt.value}
                  onClick={() => setPrefs(p => ({ ...p, spiciness_level: opt.value }))}
                  className={`w-full flex items-center gap-3 py-3 px-4 rounded-xl text-left border transition-colors ${
                    prefs.spiciness_level === opt.value
                      ? 'bg-gray-900 text-white border-gray-900'
                      : 'bg-white text-gray-700 border-gray-200 hover:border-gray-400'
                  }`}
                >
                  <div>
                    <p className="text-sm font-medium">{opt.label}</p>
                    <p className={`text-xs ${prefs.spiciness_level === opt.value ? 'text-gray-300' : 'text-gray-400'}`}>
                      {opt.description}
                    </p>
                  </div>
                </button>
              ))}
            </div>
          </section>

          {/* Custom Mode-Switch Phrase */}
          <section className="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
            <h2 className="text-sm font-semibold text-gray-900 mb-1">Mode-Switch Phrase</h2>
            <p className="text-xs text-gray-500 mb-3">
              Type this phrase to switch between secretary and intimate mode.
              Leave blank to use the defaults ("I'm alone" / "stop").
              Tip: choose something you wouldn't normally say.
            </p>
            <input
              type="text"
              value={prefs.mode_switch_phrase ?? ''}
              onChange={e => setPrefs(p => ({ ...p, mode_switch_phrase: e.target.value || undefined }))}
              placeholder="e.g. just us now"
              className="w-full border border-gray-200 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gray-900"
            />
          </section>

          {/* Notification Preferences */}
          <section className="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
            <h2 className="text-sm font-semibold text-gray-900 mb-1">WhatsApp Notifications</h2>
            <p className="text-xs text-gray-500 mb-4">Control when Ava reaches out on WhatsApp</p>
            <label className="flex items-center justify-between cursor-pointer">
              <span className="text-sm text-gray-700">Enable WhatsApp notifications</span>
              <input
                type="checkbox"
                checked={(prefs.notif_prefs as Record<string, unknown>)?.whatsapp_enabled !== false}
                onChange={e => setPrefs(p => ({
                  ...p,
                  notif_prefs: { ...(p.notif_prefs as object ?? {}), whatsapp_enabled: e.target.checked }
                }))}
                className="w-4 h-4 rounded"
              />
            </label>
          </section>

          {/* Error / Success feedback */}
          {error && <p className="text-red-500 text-sm text-center">{error}</p>}
          {saved && <p className="text-green-600 text-sm text-center">Settings saved</p>}

          {/* Save button */}
          <button
            onClick={handleSave}
            disabled={saving}
            className="w-full bg-gray-900 text-white rounded-xl py-3 text-sm font-medium hover:bg-gray-700 disabled:opacity-50 transition-colors"
          >
            {saving ? 'Saving...' : 'Save Settings'}
          </button>
        </div>
      </div>
    </div>
  )
}
```

NOTE on persona selector: The persona (personality) is an avatar attribute (stored in the `avatars` table, not `user_preferences`). Per Phase 5 (PERS-01), there is already a PATCH /avatars/me/persona endpoint. Add a persona section to SettingsPage that calls this existing endpoint:

Add to `frontend/src/api/preferences.ts`:
```typescript
export async function updatePersona(token: string, persona: string): Promise<void> {
  const res = await fetch('/avatars/me/persona', {
    method: 'PATCH',
    headers: {
      Authorization: `Bearer ${token}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ personality: persona }),
  })
  if (!res.ok) throw new Error('Failed to update persona')
}
```

Add a Persona section to SettingsPage before the platform section:
```tsx
{/* Persona Selector */}
<section className="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
  <h2 className="text-sm font-semibold text-gray-900 mb-1">Ava's Persona</h2>
  <p className="text-xs text-gray-500 mb-4">Choose Ava's personality</p>
  <div className="grid grid-cols-3 gap-2">
    {PERSONA_OPTIONS.map(opt => (
      <button
        key={opt.value}
        onClick={() => updatePersona(token!, opt.value).catch(e => setError(e.message))}
        className="py-2 px-3 rounded-xl text-sm border border-gray-200 hover:border-gray-900 hover:bg-gray-900 hover:text-white transition-colors"
      >
        {opt.label}
      </button>
    ))}
  </div>
</section>
```

**frontend/src/pages/PhotoPage.tsx:**
```tsx
import { useSearchParams } from 'react-router-dom'
import { useNavigate } from 'react-router-dom'

export default function PhotoPage() {
  const [searchParams] = useSearchParams()
  const photoUrl = searchParams.get('url')
  const navigate = useNavigate()

  if (!photoUrl) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <p className="text-gray-500 text-sm">No photo URL provided.</p>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-black flex flex-col">
      {/* Minimal header */}
      <div className="flex items-center justify-between px-4 py-3 bg-black/80">
        <button
          onClick={() => navigate('/chat')}
          className="text-gray-300 hover:text-white text-sm transition-colors"
        >
          ‚Üê Back to chat
        </button>
        <span className="text-gray-400 text-xs">Photo from Ava</span>
      </div>

      {/* Photo display */}
      <div className="flex-1 flex items-center justify-center p-4">
        <img
          src={photoUrl}
          alt="Photo from Ava"
          className="max-w-full max-h-full rounded-lg object-contain"
          onError={(e) => {
            (e.target as HTMLImageElement).style.display = 'none'
          }}
        />
      </div>

      <p className="text-gray-600 text-xs text-center pb-4">
        This link expires in 24 hours
      </p>
    </div>
  )
}
```
  </action>
  <verify>
    <automated>cd /c/Users/raphg/Desktop/IA/ava2/frontend && npm run build 2>&1 | tail -10</automated>
    <manual>Confirm build passes. Verify SettingsPage.tsx has persona section, platform toggle, spiciness options, mode-switch input, and save button.</manual>
  </verify>
  <done>
    SettingsPage renders with all required sections: persona selector (6 options), platform toggle (WhatsApp/Web), spiciness ceiling (3 tiers), mode-switch phrase input, notification toggle, and save button. PhotoPage renders photo from ?url= query param in dark chrome. `npm run build` passes.
  </done>
</task>

</tasks>

<verification>
Run `cd frontend && npm run build` ‚Äî zero TypeScript errors.
Confirm all 6 files exist: ChatBubble.tsx, MessageList.tsx, ChatInput.tsx, ChatPage.tsx, SettingsPage.tsx, PhotoPage.tsx.
</verification>

<success_criteria>
- ChatPage: header with Ava avatar + settings/sign-out links, scrollable message list with role-based bubble alignment, input with Enter-to-send
- SettingsPage: persona selector (6 options), platform preference toggle, spiciness ceiling (3 named tiers), mode-switch phrase text input, notification toggle, save + feedback
- PhotoPage: full-screen dark layout, renders image from ?url= query param, back-to-chat link, expiry notice
- All components built without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-web-app-multi-platform/06-05-SUMMARY.md` summarizing:
- Components created and their responsibilities
- Tailwind classes used for the chat bubble layout
- Persona update API integration
- Any deviations from the plan
</output>
