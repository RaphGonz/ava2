---
phase: 02-infrastructure-user-management
plan: 05
type: execute
wave: 4
depends_on: ["02-02", "02-03", "02-04"]
files_modified: []
autonomous: false
requirements: [USER-02]

must_haves:
  truths:
    - "Two separate user accounts cannot access each other's avatars or messages"
    - "A logged-in user querying GET /avatars/me only receives their own avatar, never another user's"
    - "A logged-in user querying GET /messages only receives their own messages"
    - "WhatsApp echo test succeeds: message sent from linked phone returns '[Echo] {text}'"
    - "FastAPI server starts and serves all routes without import errors"
  artifacts:
    - path: "backend/app/main.py"
      provides: "FastAPI app with all routers mounted"
    - path: "backend/migrations/001_initial_schema.sql"
      provides: "Applied to Supabase cloud (manual step verified in checkpoint)"
  key_links:
    - from: "backend/app/dependencies.py"
      to: "Supabase RLS policies"
      via: "get_authed_supabase scopes all user queries to auth.uid()"
      pattern: "get_authed_supabase"
---

<objective>
Human verification checkpoint: confirm the full Phase 2 system works end-to-end — auth, avatar creation, RLS isolation, and WhatsApp echo.

Purpose: USER-02 (user data is fully isolated) is only provable by testing with two real accounts. This checkpoint also validates that the schema migration was applied, the server runs, and the WhatsApp webhook echoes correctly.

Output: Human confirmation that Phase 2 is functionally complete.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/02-infrastructure-user-management/02-CONTEXT.md
@.planning/phases/02-infrastructure-user-management/02-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pre-verification setup — apply migration and start server</name>
  <files></files>
  <action>
Before handing off to the human verification checkpoint, perform automated setup:

1. **Verify all files exist** — confirm key files from all prior plans are present:
   ```bash
   ls backend/app/routers/auth.py backend/app/routers/avatars.py backend/app/routers/preferences.py backend/app/routers/webhook.py backend/app/routers/messages.py backend/migrations/001_initial_schema.sql
   ```

2. **Verify imports clean** — all routers import without errors:
   ```bash
   cd backend && python -c "
   from app.routers import auth, avatars, preferences, webhook, messages, dev
   from app.services import whatsapp, user_lookup
   from app.models import auth as auth_models, avatar, preferences as pref_models, message
   print('ALL IMPORTS OK')
   "
   ```

3. **Print verification checklist for the human**:
   Output a checklist of what the human needs to do:
   - Apply migration to Supabase (copy contents of `backend/migrations/001_initial_schema.sql` into Supabase SQL Editor and run)
   - Disable email confirmation in Supabase Dashboard > Authentication > Providers > Email > uncheck "Confirm email"
   - Copy `.env.example` to `.env` and fill in Supabase credentials
   - Fill in WhatsApp env vars (or use placeholder values if testing auth only)
   - Start server: `cd backend && uvicorn app.main:app --reload --port 8000`

4. **Output the exact URLs to test**:
   - Auth test UI: `http://localhost:8000/dev/auth`
   - Onboarding test UI: `http://localhost:8000/dev/onboarding`
   - API docs: `http://localhost:8000/docs`
   - Health check: `http://localhost:8000/health`
  </action>
  <verify>
    <automated>cd /c/Users/raphg/Desktop/IA/ava2/backend && python -c "from app.routers import auth, avatars, preferences, webhook, messages; print('ALL IMPORTS OK')" 2>&1</automated>
  </verify>
  <done>
    - All routers and services import without errors
    - Pre-verification checklist printed for human
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Checkpoint: Verify full Phase 2 system end-to-end (auth, RLS isolation, WhatsApp echo)</name>
  <what-built>
Complete Phase 2 infrastructure:
- FastAPI backend with auth (signup/signin), avatar creation, WhatsApp phone linking, webhook echo, and message history
- Supabase schema with RLS policies on user_preferences, avatars, and messages tables
- Minimal dev UI at /dev/auth and /dev/onboarding for browser testing
- WhatsApp webhook that echoes messages from linked phone numbers
  </what-built>
  <how-to-verify>
**Prerequisites (do first):**
1. Apply `backend/migrations/001_initial_schema.sql` to your Supabase project (SQL Editor)
2. Disable email confirmation: Supabase Dashboard -> Authentication -> Providers -> Email -> uncheck "Confirm email"
3. Copy `backend/.env.example` to `backend/.env`, fill in your Supabase URL and keys
4. Start server: `cd backend && pip install -r requirements.txt && uvicorn app.main:app --reload`

**Test 1 — Auth works:**
5. Open `http://localhost:8000/dev/auth`
6. Sign up with `userA@test.com` / password123 — should display token
7. Sign up with `userB@test.com` / password123 — should display a different token
8. Sign in with `userA@test.com` — should return same token prefix as step 6

**Test 2 — Avatar creation works:**
9. Open `http://localhost:8000/dev/onboarding`
10. Paste User A's token
11. Create avatar: name="Luna", age=25, personality=playful, description="tall, brown hair"
12. Click "Get my avatar" — should return the avatar you just created
13. Try age=19 — should show a validation error (422)

**Test 3 — RLS isolation (USER-02 — most important test):**
14. In a different browser tab, open `http://localhost:8000/docs`
15. Authenticate as User B (use the "Authorize" button with User B's token)
16. Call `GET /avatars/me` as User B — should return 404 (User B has no avatar yet)
17. Create an avatar for User B via `POST /avatars`
18. Call `GET /avatars/me` as User A again — should return Luna, NOT User B's avatar
19. Call `GET /messages` as User A — should return only User A's messages

**Test 4 — WhatsApp echo (if WhatsApp credentials are configured):**
20. Link User A's WhatsApp phone number via PUT /preferences/whatsapp or /dev/onboarding
21. Start ngrok: `make ngrok` — copy the HTTPS URL
22. Register the ngrok URL as webhook in Meta Developer Console (with WHATSAPP_VERIFY_TOKEN)
23. Send a text message from User A's WhatsApp phone to the test number
24. Should receive "[Echo] {your message}" back on WhatsApp

**Test 5 — API health:**
25. `GET http://localhost:8000/health` — should return `{"status": "ok"}`
26. `GET http://localhost:8000/docs` — should show Swagger UI with all routes

**If WhatsApp not yet configured:** Tests 1-3 and 5 are sufficient to confirm Phase 2 complete. WhatsApp verification can be submitted in parallel and tested when credentials are ready.
  </how-to-verify>
  <resume-signal>Type "approved" if Tests 1-3 and 5 pass (WhatsApp test optional). Describe any failures.</resume-signal>
  <action>Human verifies the complete Phase 2 system using the steps in how-to-verify. No automated actions — this is a human-only verification step.</action>
  <verify>
    <automated>MISSING — this is a human verification task; automated check is not applicable</automated>
    <manual>Follow the numbered steps in how-to-verify above. Tests 1-3 and 5 are required. Test 4 (WhatsApp echo) is required if credentials are configured.</manual>
  </verify>
  <done>Human types "approved" after confirming: two accounts isolated via RLS, avatar age validation works, server health check passes.</done>
  <files>none</files>
</task>

</tasks>

<verification>
Phase 2 complete when the human verifies:
- [ ] Two accounts created successfully via /dev/auth
- [ ] Avatar created for User A, User B cannot see it (RLS confirmed)
- [ ] Age < 20 rejected with validation error
- [ ] GET /health returns {"status": "ok"}
- [ ] WhatsApp echo works OR WhatsApp Business verification submitted (in progress)
</verification>

<success_criteria>
- User A's avatar is only visible to User A (RLS enforced on avatars table)
- User A's messages are only visible to User A (RLS enforced on messages table)
- Auth works: signup creates account, signin returns token, wrong password returns 401
- Server runs without errors at localhost:8000
- WhatsApp Business Account verification submitted (echo test runs when credentials arrive)
</success_criteria>

<output>
After completion, create `.planning/phases/02-infrastructure-user-management/02-05-SUMMARY.md`
</output>
