---
phase: 02-infrastructure-user-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/main.py
  - backend/app/config.py
  - backend/app/database.py
  - backend/requirements.txt
  - backend/.env.example
  - backend/Makefile
  - backend/migrations/001_initial_schema.sql
autonomous: true
requirements: [ARCH-04, USER-02]

must_haves:
  truths:
    - "FastAPI app starts without errors when all required env vars are set"
    - "Supabase schema migration SQL creates all tables, enums, RLS policies, and indexes atomically"
    - "Two Supabase clients exist: anon key (user-facing, RLS enforced) and service role (admin ops)"
    - "All service URLs and secrets are loaded from environment variables — no hardcoded endpoints"
    - "Avatar age CHECK constraint (age >= 20) is enforced at the database level"
    - "RLS policies restrict each table to auth.uid() = user_id for authenticated users"
  artifacts:
    - path: "backend/app/main.py"
      provides: "FastAPI application factory with router mounts"
      min_lines: 20
    - path: "backend/app/config.py"
      provides: "Pydantic BaseSettings with all required env vars"
      contains: "class Settings(BaseSettings)"
    - path: "backend/app/database.py"
      provides: "Two Supabase client singletons (anon + service role)"
      contains: "supabase_admin"
    - path: "backend/migrations/001_initial_schema.sql"
      provides: "Complete schema: enums, user_preferences, avatars, messages, RLS, indexes"
      contains: "CHECK (age >= 20)"
  key_links:
    - from: "backend/app/config.py"
      to: "backend/app/database.py"
      via: "settings import"
      pattern: "from app\\.config import settings"
    - from: "backend/migrations/001_initial_schema.sql"
      to: "Supabase cloud"
      via: "manual migration apply (documented in Makefile)"
      pattern: "BEGIN.*COMMIT"
---

<objective>
Bootstrap the Python/FastAPI backend project structure and create the complete Supabase database schema migration.

Purpose: Every subsequent plan depends on this scaffold existing and the schema being applied. Getting this right first means Plan 02, 03, and 04 can execute in parallel against a stable foundation.

Output:
- `backend/` project scaffold with all required directories and files
- Supabase schema migration SQL (enums, tables, RLS, indexes) in one transactional file
- Two Supabase client singletons configured via env vars
- Makefile dev targets so the executor (and future Claude instances) can start the server in one command
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-infrastructure-user-management/02-CONTEXT.md
@.planning/phases/02-infrastructure-user-management/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend project scaffold with config and Supabase client singletons</name>
  <files>
    backend/app/__init__.py
    backend/app/main.py
    backend/app/config.py
    backend/app/database.py
    backend/app/dependencies.py
    backend/app/routers/__init__.py
    backend/app/models/__init__.py
    backend/app/services/__init__.py
    backend/requirements.txt
    backend/.env.example
    backend/Makefile
  </files>
  <action>
Create the complete backend scaffold. Use the project structure exactly as specified in RESEARCH.md § Recommended Project Structure.

**backend/requirements.txt** — pin exact versions per RESEARCH.md Standard Stack:
```
supabase==2.28.0
fastapi>=0.115.0
uvicorn[standard]>=0.30.0
httpx>=0.27.0
python-dotenv>=1.0.0
pydantic-settings>=2.0.0
python-jose[cryptography]>=3.0.0
gunicorn>=22.0.0
```

**backend/app/config.py** — implement exactly as RESEARCH.md Pattern 5. Required fields:
- `supabase_url: str`
- `supabase_anon_key: str`
- `supabase_service_role_key: str`
- `whatsapp_access_token: str`
- `whatsapp_phone_number_id: str`
- `whatsapp_verify_token: str`
- `app_env: str = "development"`
Use `model_config = SettingsConfigDict(env_file=".env", case_sensitive=False)` and `@lru_cache` on `get_settings()`.

**backend/app/database.py** — implement exactly as RESEARCH.md Code Examples (Supabase Client Initialization). Two clients:
- `supabase_client` using `settings.supabase_anon_key` — for user-facing ops with RLS
- `supabase_admin` using `settings.supabase_service_role_key` — for admin ops (webhook user lookup)

**backend/app/dependencies.py** — implement `get_current_user` and `get_authed_supabase` per RESEARCH.md Pattern 2. For `get_authed_supabase`, use `supabase_client.postgrest.auth(token)` pattern on per-query basis (safer than `set_auth()` on singleton in async context — per RESEARCH.md Open Questions #1). Return a helper that scopes postgrest operations to the user's token.

**backend/app/main.py** — create FastAPI app, mount all routers (auth, avatars, preferences, webhook, health). Add a `GET /health` route returning `{"status": "ok"}`. Include CORS middleware (allow localhost origins for dev). Serve the templates directory for the minimal test UI (Phase 2 UI is HTML forms served by FastAPI).

**backend/.env.example** — exactly as RESEARCH.md Pattern 5, plus add:
```
# App
APP_ENV=development
```
Comment each var with where to get it (e.g., `# Supabase Dashboard -> Settings -> API`).

**backend/Makefile** — targets:
- `dev`: `uvicorn app.main:app --reload --port 8000`
- `prod`: `gunicorn -w 4 -k uvicorn.workers.UvicornWorker app.main:app`
- `install`: `pip install -r requirements.txt`
- `ngrok`: `ngrok http 8000`
All targets run from the `backend/` directory (add `cd backend` note in comment or use `.PHONY` with correct working directory).

Create empty `__init__.py` files in `app/`, `app/routers/`, `app/models/`, `app/services/`.
  </action>
  <verify>
    <automated>cd /c/Users/raphg/Desktop/IA/ava2/backend && python -c "from app.config import Settings; print('config OK')" 2>&1 || echo "FAIL: config import"</automated>
    <manual>Check that backend/app/database.py contains both supabase_client and supabase_admin. Check that backend/.env.example has all 7 required vars. Check that Makefile has dev, prod, install, ngrok targets.</manual>
  </verify>
  <done>
    - `backend/requirements.txt` lists all 8 required packages with correct versions
    - `backend/app/config.py` exports `settings` singleton via `get_settings()` with all required env vars
    - `backend/app/database.py` exports `supabase_client` (anon key) and `supabase_admin` (service role)
    - `backend/app/dependencies.py` exports `get_current_user` and `get_authed_supabase`
    - `backend/app/main.py` starts FastAPI app with health route
    - `backend/.env.example` contains all env var templates with comments
    - `backend/Makefile` has dev/prod/install/ngrok targets
  </done>
</task>

<task type="auto">
  <name>Task 2: Supabase database schema migration (enums, tables, RLS, indexes)</name>
  <files>
    backend/migrations/001_initial_schema.sql
  </files>
  <action>
Create `backend/migrations/001_initial_schema.sql` as a single transactional migration file. Use exactly the schema from RESEARCH.md Pattern 3 verbatim — do not invent variations. Wrap the entire file in `BEGIN;` / `COMMIT;`.

The migration must contain in order:

1. **Extensions:**
   ```sql
   CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
   ```

2. **Enums** (exactly as specified):
   - `personality_type` with values: 'playful', 'dominant', 'shy', 'caring', 'intellectual', 'adventurous'
   - `message_channel` with values: 'app', 'whatsapp'
   - `message_role` with values: 'user', 'assistant'

3. **Tables** (exact column definitions from RESEARCH.md):
   - `public.user_preferences`: id, user_id FK to auth.users, whatsapp_phone TEXT, created_at, updated_at, UNIQUE(user_id)
   - `public.avatars`: id, user_id FK to auth.users, name TEXT NOT NULL, age INTEGER NOT NULL CHECK (age >= 20), personality personality_type NOT NULL, physical_description TEXT, created_at, UNIQUE(user_id)
   - `public.messages`: id, user_id FK to auth.users, avatar_id UUID FK to avatars ON DELETE SET NULL, channel message_channel NOT NULL, role message_role NOT NULL, content TEXT NOT NULL, created_at

4. **RLS enablement** on all 3 tables:
   ```sql
   ALTER TABLE public.user_preferences ENABLE ROW LEVEL SECURITY;
   ALTER TABLE public.avatars ENABLE ROW LEVEL SECURITY;
   ALTER TABLE public.messages ENABLE ROW LEVEL SECURITY;
   ```

5. **RLS policies** (use `(SELECT auth.uid())` wrapper not bare `auth.uid()` for performance — per RESEARCH.md Pattern 3 CRITICAL note):
   - user_preferences: SELECT, INSERT, UPDATE policies
   - avatars: SELECT, INSERT, UPDATE policies
   - messages: SELECT, INSERT policies

6. **Indexes** (all from RESEARCH.md Pattern 3):
   - `idx_user_preferences_user_id` on user_preferences(user_id)
   - `idx_avatars_user_id` on avatars(user_id)
   - `idx_messages_user_id` on messages(user_id)
   - `idx_messages_user_created` on messages(user_id, created_at DESC)
   - `idx_user_preferences_phone` PARTIAL index: `WHERE whatsapp_phone IS NOT NULL`

Add a header comment block with: migration number, date, description, and how to apply (manual copy-paste into Supabase SQL Editor or `psql` command).

Also add a note at the top: "IMPORTANT: After applying this migration, disable email confirmation in Supabase Dashboard > Authentication > Providers > Email > uncheck 'Confirm email'" — this is required for Phase 2's immediate-token signup flow.
  </action>
  <verify>
    <automated>grep -c "CREATE TABLE" /c/Users/raphg/Desktop/IA/ava2/backend/migrations/001_initial_schema.sql && grep -c "ENABLE ROW LEVEL SECURITY" /c/Users/raphg/Desktop/IA/ava2/backend/migrations/001_initial_schema.sql && grep "CHECK (age >= 20)" /c/Users/raphg/Desktop/IA/ava2/backend/migrations/001_initial_schema.sql</automated>
    <manual>Verify migration file starts with BEGIN; and ends with COMMIT;. Verify 5 indexes exist including the partial index on whatsapp_phone. Verify all policies use (SELECT auth.uid()) not bare auth.uid().</manual>
  </verify>
  <done>
    - `backend/migrations/001_initial_schema.sql` exists, wrapped in BEGIN/COMMIT
    - Contains 3 ENUMs, 3 tables, 3 RLS enablements, 9 RLS policies, 5 indexes
    - avatars.age has `CHECK (age >= 20)` constraint
    - Partial index on whatsapp_phone with `WHERE whatsapp_phone IS NOT NULL`
    - All RLS policies use `(SELECT auth.uid())` wrapper for performance
    - Header comment explains how to apply and the email confirmation requirement
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `cd backend && python -c "from app.config import Settings; from app.database import supabase_client, supabase_admin; print('imports OK')"` — should print "imports OK" (may fail if no .env, but import should succeed with pydantic-settings lazy validation)
2. `grep -E "BEGIN;|COMMIT;" backend/migrations/001_initial_schema.sql` — should return both lines
3. `grep "CHECK (age >= 20)" backend/migrations/001_initial_schema.sql` — should return the constraint line
4. `cat backend/.env.example` — should show all 7 required env vars with comments
</verification>

<success_criteria>
- FastAPI project scaffold exists at `backend/` with correct directory structure
- All required Python packages listed in `requirements.txt`
- Config loaded from env vars via pydantic-settings (no hardcoded URLs or secrets)
- Two Supabase clients: anon (user-facing, RLS enforced) and service role (admin ops)
- Migration SQL creates all tables with correct constraints, RLS, and indexes in one transaction
- `make dev` target defined for local development startup
</success_criteria>

<output>
After completion, create `.planning/phases/02-infrastructure-user-management/02-01-SUMMARY.md`
</output>
