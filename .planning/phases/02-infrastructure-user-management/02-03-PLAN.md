---
phase: 02-infrastructure-user-management
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - backend/app/routers/avatars.py
  - backend/app/routers/preferences.py
  - backend/app/models/avatar.py
  - backend/app/models/preferences.py
  - backend/templates/onboarding.html
  - backend/app/routers/dev.py
autonomous: true
requirements: [USER-03]

must_haves:
  truths:
    - "Authenticated user can POST /avatars to create their avatar with name, age (>=20), personality, and physical_description"
    - "POST /avatars with age < 20 returns HTTP 422 (validation error) — DB constraint + Pydantic validation both enforce the floor"
    - "Authenticated user can GET /avatars/me to retrieve their avatar"
    - "POST /avatars when user already has an avatar returns HTTP 400 (one avatar per user)"
    - "Authenticated user can PUT /preferences/whatsapp to link their phone number in E.164 format"
    - "PUT /preferences/whatsapp with non-E.164 format returns HTTP 400"
    - "Onboarding dev page at /dev/onboarding allows testing avatar creation and phone linking in a browser"
  artifacts:
    - path: "backend/app/models/avatar.py"
      provides: "AvatarCreate, AvatarResponse Pydantic models with age >= 20 validator"
      contains: "ge=20"
    - path: "backend/app/routers/avatars.py"
      provides: "POST /avatars and GET /avatars/me endpoints"
      exports: ["router"]
    - path: "backend/app/models/preferences.py"
      provides: "PhoneLinkRequest Pydantic model with E.164 validation"
      contains: "E.164"
    - path: "backend/app/routers/preferences.py"
      provides: "PUT /preferences/whatsapp and GET /preferences endpoints"
      exports: ["router"]
    - path: "backend/templates/onboarding.html"
      provides: "Barebones HTML for avatar creation and phone linking (no styling)"
  key_links:
    - from: "backend/app/routers/avatars.py"
      to: "backend/app/database.py"
      via: "get_authed_supabase dependency — RLS enforces user_id isolation"
      pattern: "Depends\\(get_authed_supabase\\)"
    - from: "backend/app/models/avatar.py"
      to: "backend/migrations/001_initial_schema.sql"
      via: "personality enum values must match DB personality_type enum"
      pattern: "personality_type.*Enum"
---

<objective>
Implement the avatar creation and user preferences (phone linking) API endpoints, plus a minimal dev HTML page to test the onboarding flow in a browser.

Purpose: USER-03 (user can configure avatar and persona during onboarding) requires these endpoints. The personality enum in the Pydantic model must match the DB enum defined in Plan 01's migration.

Output:
- `POST /avatars` — creates avatar for authenticated user (one per user, age >= 20 enforced)
- `GET /avatars/me` — returns current user's avatar
- `PUT /preferences/whatsapp` — links WhatsApp phone number (E.164 format)
- `GET /preferences` — returns current user's preferences
- `GET /dev/onboarding` — barebones HTML to test the flow
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/02-infrastructure-user-management/02-CONTEXT.md
@.planning/phases/02-infrastructure-user-management/02-RESEARCH.md
@.planning/phases/02-infrastructure-user-management/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Avatar and preferences Pydantic models and API endpoints</name>
  <files>
    backend/app/models/avatar.py
    backend/app/models/preferences.py
    backend/app/routers/avatars.py
    backend/app/routers/preferences.py
  </files>
  <action>
**backend/app/models/avatar.py** — define Pydantic models:

```python
from enum import Enum
from pydantic import BaseModel, Field
from typing import Optional
from datetime import datetime
import uuid

class PersonalityType(str, Enum):
    playful = "playful"
    dominant = "dominant"
    shy = "shy"
    caring = "caring"
    intellectual = "intellectual"
    adventurous = "adventurous"

class AvatarCreate(BaseModel):
    name: str = Field(..., min_length=1, max_length=100)
    age: int = Field(..., ge=20, description="Avatar age — minimum 20 per compliance policy")
    personality: PersonalityType
    physical_description: Optional[str] = Field(None, max_length=2000)

class AvatarResponse(BaseModel):
    id: str
    user_id: str
    name: str
    age: int
    personality: PersonalityType
    physical_description: Optional[str]
    created_at: datetime
```

The `PersonalityType` enum values MUST match the `personality_type` enum in `backend/migrations/001_initial_schema.sql` exactly (playful, dominant, shy, caring, intellectual, adventurous).

**backend/app/models/preferences.py**:

```python
from pydantic import BaseModel, field_validator
from typing import Optional
from datetime import datetime

class PhoneLinkRequest(BaseModel):
    phone: str

    @field_validator("phone")
    @classmethod
    def validate_e164(cls, v: str) -> str:
        """E.164 format: + followed by 7-15 digits."""
        if not v.startswith("+") or not v[1:].isdigit() or not (7 <= len(v[1:]) <= 15):
            raise ValueError("Phone must be in E.164 format: +1234567890 (+ followed by 7-15 digits)")
        return v

class PreferencesResponse(BaseModel):
    id: str
    user_id: str
    whatsapp_phone: Optional[str]
    created_at: datetime
    updated_at: datetime
```

**backend/app/routers/avatars.py** — implement per RESEARCH.md Code Examples (Avatar Creation Endpoint):

- `POST /avatars` — requires `get_current_user` and `get_authed_supabase` dependencies. Check for existing avatar first (return 400 if exists). Insert avatar row. Return `AvatarResponse`.
- `GET /avatars/me` — requires auth. Query `avatars` table for `user_id == current_user.id`. Return 404 if no avatar yet.

**backend/app/routers/preferences.py** — implement per RESEARCH.md Code Examples (Phone Linking Endpoint):

- `PUT /preferences/whatsapp` — requires auth. Validate E.164 (Pydantic model handles this). Upsert into `user_preferences`. Return `{"status": "linked", "phone": phone}`.
- `GET /preferences` — requires auth. Return current user's preferences row. Return 404 if no preferences row exists yet (user hasn't linked phone).

Register both routers in `backend/app/main.py`:
```python
from app.routers import avatars, preferences
app.include_router(avatars.router)
app.include_router(preferences.router)
```
  </action>
  <verify>
    <automated>cd /c/Users/raphg/Desktop/IA/ava2/backend && python -c "from app.routers.avatars import router; from app.routers.preferences import router as pr; print('avatar and preferences routers OK')" 2>&1</automated>
    <manual>Check that AvatarCreate has `ge=20` on the age field. Check that PersonalityType enum values match the DB migration exactly. Check that PhoneLinkRequest has E.164 validator. Check that POST /avatars uses get_authed_supabase (not supabase_admin).</manual>
  </verify>
  <done>
    - `AvatarCreate.age` field has `ge=20` (Pydantic rejects age < 20 with 422)
    - `PersonalityType` enum matches DB `personality_type` enum (6 values)
    - `PhoneLinkRequest` validates E.164 format with field_validator
    - `POST /avatars` returns 400 when user already has an avatar
    - `GET /avatars/me` returns 404 when user has no avatar
    - Both routers registered in main.py
    - All user-facing endpoints use `get_authed_supabase` (RLS enforced), not `supabase_admin`
  </done>
</task>

<task type="auto">
  <name>Task 2: Barebones onboarding dev page for avatar creation and phone linking</name>
  <files>
    backend/templates/onboarding.html
    backend/app/routers/dev.py
  </files>
  <action>
**backend/templates/onboarding.html** — barebones HTML with no styling. Contains:

1. **Token input**: A text field at the top where user pastes their JWT from the auth page. This is stored in a JS variable for use in subsequent fetch calls. Label it: "Bearer Token (from /dev/auth signup/signin)".

2. **Avatar creation form** (POST /avatars):
   - Name input (text)
   - Age input (number, min=20 enforced on client too)
   - Personality select with all 6 options matching `PersonalityType` enum: playful, dominant, shy, caring, intellectual, adventurous
   - Physical description textarea
   - Submit button: "Create Avatar"
   - Result `<p>` showing success (avatar id, name) or error

3. **Phone linking form** (PUT /preferences/whatsapp):
   - Phone input with placeholder "+1234567890"
   - Submit button: "Link WhatsApp Number"
   - Result `<p>` showing "Linked: {phone}" or error

4. **Get my avatar** button (GET /avatars/me):
   - Simple button that fetches and displays current avatar

All fetch calls include `Authorization: Bearer {token}` header using the token from the top input field.

Add navigation link: `<a href="/dev/auth">Back to Auth</a>`.

**backend/app/routers/dev.py** — add the new route to the existing dev router (this file was created in Plan 02):
```python
@router.get("/dev/onboarding")
async def dev_onboarding():
    if settings.app_env != "development":
        raise HTTPException(404)
    # Read and return onboarding.html
```

Use `pathlib.Path` to resolve the templates directory (same pattern as the auth.html route).

IMPORTANT: Do NOT modify the existing `/dev/auth` route — only add `/dev/onboarding` to the router.
  </action>
  <verify>
    <automated>grep -c "fetch('/avatars'" /c/Users/raphg/Desktop/IA/ava2/backend/templates/onboarding.html && grep "fetch('/preferences/whatsapp'" /c/Users/raphg/Desktop/IA/ava2/backend/templates/onboarding.html</automated>
    <manual>Check that the personality select has exactly 6 options matching PersonalityType enum. Check that all fetch calls include the Authorization header. Check that age input has min=20.</manual>
  </verify>
  <done>
    - `backend/templates/onboarding.html` exists with avatar creation and phone linking forms
    - Token input at top used in all fetch calls as Bearer auth
    - Personality select has all 6 options matching enum
    - `GET /dev/onboarding` serves the page in development mode
    - No external CSS/JS dependencies
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `python -c "from app.models.avatar import AvatarCreate; m = AvatarCreate(name='test', age=19, personality='playful'); print('FAIL: should have raised')" 2>&1 | grep -i "validation\|error"` — should show validation error for age < 20
2. `python -c "from app.models.preferences import PhoneLinkRequest; PhoneLinkRequest(phone='invalid'); print('FAIL')" 2>&1 | grep -i "validation\|error"` — should show E.164 validation error
3. `grep "Depends(get_authed_supabase)" backend/app/routers/avatars.py` — should match (not supabase_admin)
4. `grep "/dev/onboarding" backend/app/routers/dev.py` — should match
</verification>

<success_criteria>
- `POST /avatars` with age=19 returns HTTP 422 (Pydantic validation error)
- `POST /avatars` creates avatar when age >= 20 and user is authenticated
- `GET /avatars/me` returns the user's avatar or 404
- `PUT /preferences/whatsapp` with "invalid" returns HTTP 422
- `PUT /preferences/whatsapp` with valid E.164 stores the phone number
- Avatar and preferences endpoints all use RLS-enforced supabase client
- Onboarding dev page accessible at /dev/onboarding in development mode
</success_criteria>

<output>
After completion, create `.planning/phases/02-infrastructure-user-management/02-03-SUMMARY.md`
</output>
