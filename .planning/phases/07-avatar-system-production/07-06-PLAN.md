---
phase: 07-avatar-system-production
plan: 06
type: execute
wave: 4
depends_on: ["07-04", "07-05"]
files_modified: []
autonomous: false
requirements: [AVTR-01, AVTR-02, AVTR-03, AVTR-04, AVTR-05, INTM-03, ARCH-03, BILL-01, BILL-02]

must_haves:
  truths:
    - "Avatar setup form works end-to-end: submit → reference image displayed"
    - "ImageProvider Protocol isinstance() check passes for ReplicateProvider"
    - "Stripe Checkout redirects correctly (dev: test mode; prod: live mode)"
    - "Subscription gate returns 402 for unauthenticated/unsubscribed users"
    - "Docker Compose starts all 4 services cleanly (docker compose up -d)"
    - "Frontend build is clean (zero TypeScript errors)"
    - "All existing tests still pass (no regressions)"
    - "Sentry initialization does not crash on empty DSN"
  artifacts:
    - path: "backend/app/services/image/base.py"
      provides: "ImageProvider Protocol"
      contains: "ImageProvider"
    - path: "backend/app/services/jobs/queue.py"
      provides: "enqueue_photo_job"
      contains: "enqueue_photo_job"
    - path: "backend/app/routers/billing.py"
      provides: "POST /billing/checkout and /billing/webhook"
      contains: "checkout"
    - path: "docker-compose.yml"
      provides: "Production deployment config"
      contains: "worker"
    - path: "frontend/src/pages/AvatarSetupPage.tsx"
      provides: "Avatar onboarding flow"
      contains: "AvatarSetupPage"
  key_links:
    - from: "backend/app/services/chat.py"
      to: "backend/app/services/jobs/queue.py"
      via: "enqueue_photo_job in intimate mode tool_calls detection"
      pattern: "enqueue_photo_job"
    - from: "frontend/src/App.tsx"
      to: "GET /avatars/me"
      via: "OnboardingGate useQuery — redirects to /avatar-setup when null"
      pattern: "OnboardingGate"
---

<objective>
End-to-end verification checkpoint for Phase 7. Automated checks confirm structural correctness; human walkthrough confirms the avatar setup flow, billing redirect, and production deployment work correctly.

Purpose: Phase 7 is the final phase — it adds image generation, billing, and production infrastructure. Human approval is required before declaring the project beta-ready.

Output: Phase 7 verified complete or gap list for closure.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-avatar-system-production/07-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Automated verification — structural checks across all Phase 7 components</name>
  <files></files>
  <action>
Run the following 12 automated checks in order. Record pass/fail for each. Stop on first failure and fix before continuing.

**Check 1: Python imports — all new packages importable**
```bash
cd backend && python -c "
from app.services.image.base import ImageProvider, GeneratedImage
from app.services.image.replicate_provider import ReplicateProvider
from app.services.image.prompt_builder import build_avatar_prompt
from app.services.image.watermark import apply_watermark
from app.services.jobs.queue import enqueue_photo_job
from app.services.jobs.processor import process_photo_job
from app.services.billing.subscription import activate_subscription, get_subscription_status
from app.routers.billing import router as billing_router
from app.dependencies import require_active_subscription
from app.models.avatar import AvatarCreate, AvatarUpdate, AvatarResponse
print('All Phase 7 Python imports: PASS')
"
```

**Check 2: ImageProvider Protocol isinstance() check (ARCH-03)**
```bash
cd backend && python -c "
from app.services.image.base import ImageProvider
from app.services.image.replicate_provider import ReplicateProvider
assert isinstance(ReplicateProvider(), ImageProvider)
print('ImageProvider Protocol (ARCH-03): PASS')
"
```

**Check 3: Avatar model has gender and nationality fields**
```bash
cd backend && python -c "
from app.models.avatar import AvatarCreate, AvatarResponse
a = AvatarCreate(name='Ava', age=25, personality='caring', gender='woman', nationality='French')
assert a.gender == 'woman' and a.nationality == 'French'
r = AvatarResponse(id='x', user_id='y', name='Ava', age=25, personality='caring', created_at='2026-01-01T00:00:00')
assert hasattr(r, 'gender') and hasattr(r, 'nationality')
print('Avatar model fields (AVTR-01 through AVTR-04): PASS')
"
```

**Check 4: Config has all Phase 7 fields (BILL-02 config-driven)**
```bash
cd backend && python -c "
from app.config import settings
for f in ['stripe_secret_key','stripe_webhook_secret','stripe_price_id','sentry_dsn','replicate_api_token','redis_url']:
    assert hasattr(settings, f), f'Missing: {f}'
print('Config fields (BILL-02): PASS')
"
```

**Check 5: Billing router routes registered**
```bash
cd backend && python -c "
from app.routers.billing import router
paths = [r.path for r in router.routes]
assert '/billing/checkout' in paths and '/billing/webhook' in paths
print('Billing routes (BILL-01): PASS')
"
```

**Check 6: send_photo tool wired in chat.py (INTM-03)**
```bash
cd backend && python -c "
from app.services.chat import SEND_PHOTO_TOOL, PHOTO_PLACEHOLDER_MSG
assert SEND_PHOTO_TOOL['function']['name'] == 'send_photo'
import inspect, app.services.chat as c
assert 'enqueue_photo_job' in inspect.getsource(c.ChatService.handle_message)
print('send_photo tool call (INTM-03): PASS')
"
```

**Check 7: Full test suite — no regressions**
```bash
cd backend && python -m pytest tests/ -x -q 2>&1
```
Expected: all existing tests pass.

**Check 8: Frontend build — zero TypeScript errors**
```bash
cd frontend && npm run build 2>&1
```
Expected: `built in Xs` with no error lines.

**Check 9: Docker Compose config validity**
```bash
docker compose -f docker-compose.yml config --quiet 2>&1
```
Expected: exits with 0, no error output.

**Check 10: Migration file content**
```bash
grep -c "gender\|subscriptions" backend/migrations/004_phase7_avatar_fields.sql && echo "Migration: PASS"
```

**Check 11: .env.example completeness**
```bash
for v in STRIPE_SECRET_KEY STRIPE_WEBHOOK_SECRET STRIPE_PRICE_ID SENTRY_DSN REPLICATE_API_TOKEN REDIS_URL; do
  grep -q "$v" backend/.env.example && echo "$v: present" || echo "$v: MISSING"
done
```

**Check 12: worker_main.py syntax**
```bash
cd backend && python -c "
import ast; src = open('worker_main.py').read(); ast.parse(src)
assert 'Worker' in src and 'asyncio.Future' in src and 'process_photo_job' in src
print('worker_main.py: PASS')
"
```

After all 12 checks pass, print a summary table before proceeding to the human checkpoint.
  </action>
  <verify>
    <automated>cd "C:/Users/raphg/Desktop/IA/ava2/backend" && python -c "from app.services.image.base import ImageProvider; from app.services.image.replicate_provider import ReplicateProvider; assert isinstance(ReplicateProvider(), ImageProvider); print('Phase 7 smoke test: PASS')"</automated>
    <sampling_rate>run all 12 checks; report results in table</sampling_rate>
  </verify>
  <done>All 12 automated checks pass. Full test suite shows no regressions. Frontend build clean. Docker Compose config valid.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification — avatar onboarding, billing paywall, and Docker Compose</name>
  <files></files>
  <action>
Human walkthrough of Phase 7 features. Run backend and frontend locally, then follow each test below.

Start servers: `cd backend && uvicorn app.main:app --reload` and `cd frontend && npm run dev`

**Test 1 — Avatar onboarding gate:**
1. Sign in to http://localhost:3000
2. If no avatar exists: app should redirect to /avatar-setup automatically
3. Fill form: name, age (20+), gender, nationality, appearance description, personality
4. Click "Create Ava and Generate Photo"
5. Expected: loading state → reference image shown with Regenerate + "Looks perfect" buttons
6. Click Regenerate → new image generated
7. Click "Looks perfect" → redirected to /chat (no redirect loop back to /avatar-setup)

**Test 2 — Subscription gate (402 paywall):**
1. Send a chat message without an active subscription in DB
2. Expected: yellow paywall banner with "Subscribe" link appears in ChatPage
3. Click Subscribe → /subscribe page shown
4. (If STRIPE_SECRET_KEY configured) Click "Subscribe now" → redirected to Stripe Checkout

**Test 3 — ARCH-03 structural check (run in terminal):**
`cd backend && python -c "from app.services.image.base import ImageProvider; from app.services.image.replicate_provider import ReplicateProvider; assert isinstance(ReplicateProvider(), ImageProvider); print('ARCH-03: PASS')"`
Expected: prints "ARCH-03: PASS"

**Test 4 — Docker Compose:**
1. `cd frontend && npm run build` (build static files)
2. `docker compose up -d` (from project root)
3. `docker compose ps` — all 4 services (nginx, backend, worker, redis) show "running"
4. `curl http://localhost/health` → 200 OK from FastAPI
5. `docker compose down`

**Test 5 — Sentry empty DSN (no crash):**
With SENTRY_DSN empty in .env: `cd backend && uvicorn app.main:app --reload`
Expected: backend starts without errors (empty DSN = disabled, no exception)

**Test 6 — Migration SQL (manual review):**
Open `backend/migrations/004_phase7_avatar_fields.sql` — confirm gender/nationality columns and subscriptions table with RLS are present. Apply in Supabase Dashboard SQL editor if not yet applied.

**Photo delivery note (INTM-03):**
Full end-to-end photo delivery requires Redis + REPLICATE_API_TOKEN + Supabase photos bucket. Verify in production. Mark as deferred if unavailable locally.
  </action>
  <verify>
    <automated>MISSING — this is a human-only verification task</automated>
    <manual>Human confirms Tests 1-5 above pass. Describe any failures.</manual>
  </verify>
  <done>Human approves Tests 1-5. Phase 7 declared complete. All requirement IDs verified: AVTR-01 through AVTR-05, INTM-03, ARCH-03, BILL-01, BILL-02.</done>
  <what-built>
    Complete Phase 7 system: avatar setup form with reference image generation; LLM send_photo tool call in intimate mode; Stripe Checkout billing with 402 subscription gate; Docker Compose production deployment (nginx + backend + worker + redis); Sentry error tracking.
  </what-built>
  <resume-signal>
    Type "approved" if Tests 1-5 pass. Or describe specific failures for gap closure.
  </resume-signal>
</task>

</tasks>

<verification>
Phase 7 complete when:
- All 12 automated checks pass
- Human approval received for Tests 1-5
- All requirement IDs covered: AVTR-01, AVTR-02, AVTR-03, AVTR-04, AVTR-05, INTM-03, ARCH-03, BILL-01, BILL-02
</verification>

<success_criteria>
1. Avatar setup end-to-end: form → reference image → approve → /chat (no redirect loop)
2. Subscription gate: 402 response → paywall banner → /subscribe → Stripe Checkout
3. ARCH-03: isinstance(ReplicateProvider(), ImageProvider) == True
4. Docker Compose: all 4 services start cleanly with docker compose up -d
5. Sentry: empty DSN = no crash; production DSN = errors captured
6. All existing tests pass (no regressions from Phase 7 additions)
</success_criteria>

<output>
After completion, create `.planning/phases/07-avatar-system-production/07-06-SUMMARY.md`
</output>
