---
phase: 07-avatar-system-production
plan: 05
type: execute
wave: 3
depends_on: ["07-02"]
files_modified:
  - frontend/src/pages/SubscribePage.tsx
  - frontend/src/api/billing.ts
  - frontend/src/pages/ChatPage.tsx
  - backend/app/main.py
  - docker-compose.yml
  - nginx.conf
  - backend/.env.example
  - backend/requirements.txt
autonomous: true
requirements: [BILL-01, BILL-02, ARCH-03]
user_setup:
  - service: stripe
    why: "Monthly subscription billing"
    env_vars:
      - name: STRIPE_SECRET_KEY
        source: "Stripe Dashboard -> Developers -> API keys -> Secret key"
      - name: STRIPE_WEBHOOK_SECRET
        source: "Stripe Dashboard -> Developers -> Webhooks -> signing secret (after adding webhook endpoint)"
      - name: STRIPE_PRICE_ID
        source: "Stripe Dashboard -> Products -> create monthly product -> Price ID (e.g. price_xxx)"
    dashboard_config:
      - task: "Create a monthly subscription product"
        location: "Stripe Dashboard -> Products -> Add product -> Recurring -> Monthly"
      - task: "Register webhook endpoint"
        location: "Stripe Dashboard -> Developers -> Webhooks -> Add endpoint -> URL: https://your-domain/billing/webhook -> Events: checkout.session.completed, invoice.payment_failed, customer.subscription.deleted"
  - service: sentry
    why: "Error tracking in production"
    env_vars:
      - name: SENTRY_DSN
        source: "Sentry -> Project -> Settings -> Client Keys (DSN)"
    dashboard_config:
      - task: "Create a Sentry project (Python / FastAPI)"
        location: "sentry.io -> New Project -> Python"
  - service: uptimerobot
    why: "Uptime monitoring and downtime alerts (per CONTEXT.md locked decision)"
    dashboard_config:
      - task: "Register account and add monitor"
        location: "uptimerobot.com -> Add New Monitor -> HTTP(s) -> URL: https://your-domain/health -> Alert contact: your email"
  - service: replicate
    why: "AI image generation for avatar photos"
    env_vars:
      - name: REPLICATE_API_TOKEN
        source: "replicate.com -> Account -> API tokens"

must_haves:
  truths:
    - "SubscribePage shows a Subscribe button that redirects to Stripe Checkout when clicked"
    - "After successful payment, Stripe webhook activates subscription and user can access chat"
    - "ChatPage shows paywall banner (402 response) with link to /subscribe when subscription inactive"
    - "Docker Compose starts backend, worker, redis, and nginx with single 'docker compose up -d'"
    - "nginx serves frontend static files and proxies /auth /chat /billing /avatars /preferences /photos /webhook to backend"
    - ".env.example documents all required environment variables"
    - "Sentry initialized in main.py — errors captured in production"
  artifacts:
    - path: "frontend/src/pages/SubscribePage.tsx"
      provides: "Stripe Checkout redirect trigger with loading state"
      min_lines: 40
    - path: "frontend/src/api/billing.ts"
      provides: "createCheckoutSession() calling POST /billing/checkout"
      exports: ["createCheckoutSession"]
    - path: "docker-compose.yml"
      provides: "nginx + backend + worker + redis services"
      contains: "worker"
    - path: "nginx.conf"
      provides: "reverse proxy config — static files + /api proxy"
      contains: "proxy_pass"
    - path: "backend/.env.example"
      provides: "All required env vars documented with placeholder values"
      contains: "STRIPE_SECRET_KEY"
  key_links:
    - from: "frontend/src/pages/SubscribePage.tsx"
      to: "POST /billing/checkout"
      via: "createCheckoutSession() fetch call + window.location.href redirect"
      pattern: "createCheckoutSession"
    - from: "frontend/src/pages/ChatPage.tsx"
      to: "POST /chat (402 response)"
      via: "useSendMessage mutation error handler checks status 402 → shows subscribe banner"
      pattern: "402"
    - from: "backend/app/main.py"
      to: "sentry_sdk"
      via: "sentry_sdk.init(dsn=settings.sentry_dsn) before app = FastAPI()"
      pattern: "sentry_sdk\\.init"
    - from: "docker-compose.yml"
      to: "backend/worker_main.py"
      via: "worker service: command: python worker_main.py"
      pattern: "worker_main"
---

<objective>
Build the SubscribePage paywall, Docker Compose production deployment, Sentry error tracking, and complete the .env.example documentation.

Purpose: The billing flow completes when users can click Subscribe → Stripe → return to /chat. Production deployment enables beta launch. Sentry enables error monitoring from day one.

Output: SubscribePage + billing.ts API; paywall banner in ChatPage; Docker Compose (nginx + backend + worker + redis); nginx.conf; .env.example; Sentry init in main.py.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-avatar-system-production/07-CONTEXT.md
@.planning/phases/07-avatar-system-production/07-RESEARCH.md
@backend/app/main.py
@backend/app/config.py
@frontend/src/pages/ChatPage.tsx
@frontend/src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: SubscribePage + billing API + ChatPage paywall banner + Sentry init</name>
  <files>
    frontend/src/pages/SubscribePage.tsx
    frontend/src/api/billing.ts
    frontend/src/pages/ChatPage.tsx
    backend/app/main.py
    backend/requirements.txt
  </files>
  <action>
**`frontend/src/api/billing.ts`** — Billing API:
```typescript
/**
 * Billing API — creates Stripe Checkout session and returns redirect URL.
 */
export async function createCheckoutSession(token: string): Promise<{ checkout_url: string }> {
  const res = await fetch('/billing/checkout', {
    method: 'POST',
    headers: { Authorization: `Bearer ${token}` },
  })
  if (!res.ok) {
    const err = await res.json().catch(() => ({ detail: 'Billing unavailable' }))
    throw new Error(err.detail || 'Failed to create checkout session')
  }
  return res.json()
}
```

**`frontend/src/pages/SubscribePage.tsx`** — Stripe Checkout redirect:
```tsx
/**
 * SubscribePage — shown when user tries to chat without an active subscription.
 * POST /billing/checkout → receives Stripe Checkout URL → redirect.
 */
import { useState } from 'react'
import { useAuthStore } from '../store/useAuthStore'
import { createCheckoutSession } from '../api/billing'

export default function SubscribePage() {
  const token = useAuthStore(s => s.token)!
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)

  // Read URL params for cancel feedback
  const params = new URLSearchParams(window.location.search)
  const cancelled = params.get('cancelled') === '1'

  const handleSubscribe = async () => {
    setLoading(true)
    setError(null)
    try {
      const { checkout_url } = await createCheckoutSession(token)
      window.location.href = checkout_url
    } catch (err: unknown) {
      setError(err instanceof Error ? err.message : 'Something went wrong')
      setLoading(false)
    }
  }

  return (
    <div className="min-h-screen bg-gray-950 text-white flex items-center justify-center p-4">
      <div className="w-full max-w-sm bg-gray-900 rounded-2xl p-8 space-y-6 text-center">
        <div>
          <h1 className="text-2xl font-bold">Unlock Ava</h1>
          <p className="text-gray-400 mt-2 text-sm">
            Subscribe to start chatting and receiving photos.
          </p>
        </div>

        {cancelled && (
          <p className="text-yellow-400 text-sm">
            Checkout cancelled — no charge made.
          </p>
        )}

        <div className="bg-gray-800 rounded-xl p-4 space-y-2">
          <p className="text-lg font-semibold">Monthly subscription</p>
          <ul className="text-gray-400 text-sm space-y-1 text-left">
            <li>Unlimited chat in secretary and intimate modes</li>
            <li>AI-generated photos during intimate conversations</li>
            <li>All persona styles included</li>
          </ul>
        </div>

        {error && <p className="text-red-400 text-sm">{error}</p>}

        <button
          onClick={handleSubscribe}
          disabled={loading}
          className="w-full bg-purple-600 hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-semibold py-3 rounded-xl transition-colors"
        >
          {loading ? 'Redirecting to checkout...' : 'Subscribe now'}
        </button>

        <p className="text-xs text-gray-500">
          Secure payment via Stripe. Cancel anytime.
        </p>
      </div>
    </div>
  )
}
```

**`frontend/src/pages/ChatPage.tsx`** — Add paywall banner for 402 responses. Read the existing ChatPage.tsx, then add a `subscriptionRequired` state that is set to `true` when `useSendMessage` mutation receives a 402 error. Show a banner above the chat input when active. Add to the component:

```tsx
// Add to existing ChatPage.tsx (do not replace — surgical addition):

// 1. Add state after existing state declarations:
const [subscriptionRequired, setSubscriptionRequired] = useState(false)

// 2. In useMutation onError handler (or add one if missing), check for 402:
// When fetch returns 402, the error message will contain "Subscription required"
// Set subscriptionRequired = true to show the banner

// 3. Add banner above ChatInput (inside the chat container):
{subscriptionRequired && (
  <div className="bg-yellow-900/50 border border-yellow-600 rounded-lg p-3 mx-4 mb-2 flex items-center justify-between">
    <p className="text-yellow-200 text-sm">
      Subscription required to send messages.
    </p>
    <a
      href="/subscribe"
      className="text-yellow-400 underline text-sm font-medium ml-4 whitespace-nowrap"
    >
      Subscribe
    </a>
  </div>
)}
```

Read the full existing ChatPage.tsx before making changes. Preserve all existing functionality (history loading, send, persona display). Add the subscriptionRequired state and 402 error check to the existing useMutation onError callback. If no onError exists, add one.

**`backend/app/main.py`** — Add Sentry initialization before `app = FastAPI()`. Add at the top of the file:
```python
import sentry_sdk
from app.config import settings as _config

# Sentry init — call BEFORE FastAPI app creation
# Empty DSN (dev default) = disabled; production DSN in env
sentry_sdk.init(
    dsn=_config.sentry_dsn,
    environment=_config.app_env,
    traces_sample_rate=0.1,  # 10% of requests for performance tracing
    # FastAPI integration activates automatically — no explicit FastApiIntegration() needed
)
```

Add `sentry-sdk` to `backend/requirements.txt`:
```
sentry-sdk
```
  </action>
  <verify>
    <automated>cd "C:/Users/raphg/Desktop/IA/ava2/frontend" && npm run build 2>&1 | tail -8</automated>
    <manual>Verify backend: `cd backend && python -c "from app.main import app; print('main.py imports OK')"` — no import errors. `grep "sentry_sdk.init" backend/app/main.py` — found.</manual>
    <sampling_rate>run after task 1</sampling_rate>
  </verify>
  <done>
    billing.ts with createCheckoutSession(). SubscribePage with Stripe redirect and cancel feedback. ChatPage shows 402 paywall banner with /subscribe link. sentry_sdk.init() in main.py before FastAPI(). sentry-sdk in requirements.txt. Frontend build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Docker Compose production config + nginx.conf + .env.example</name>
  <files>
    docker-compose.yml
    nginx.conf
    backend/.env.example
  </files>
  <action>
Create production deployment files at the project root (same level as `backend/` and `frontend/`).

**`docker-compose.yml`** (project root):
```yaml
version: "3.9"

services:
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./frontend/dist:/usr/share/nginx/html:ro
      - ./certbot/conf:/etc/letsencrypt:ro   # optional: mount Let's Encrypt certs
    depends_on:
      - backend
    restart: unless-stopped

  backend:
    build: ./backend
    env_file: ./backend/.env
    environment:
      - REDIS_URL=redis://redis:6379
    depends_on:
      - redis
    restart: unless-stopped
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 2

  worker:
    build: ./backend
    command: python worker_main.py
    env_file: ./backend/.env
    environment:
      - REDIS_URL=redis://redis:6379
    depends_on:
      - redis
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    # No exposed port — only backend and worker connect internally
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes  # AOF persistence for job durability

volumes:
  redis_data:
```

**`nginx.conf`** (project root):
```nginx
events {
    worker_processes 1;
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    sendfile      on;
    gzip          on;
    gzip_types    text/plain text/css application/json application/javascript text/javascript;

    server {
        listen 80;
        server_name _;

        # Serve React frontend static files
        root /usr/share/nginx/html;
        index index.html;

        # API proxy — route backend paths to FastAPI
        location ~ ^/(auth|chat|billing|avatars|preferences|photos|webhook|messages|dev|health) {
            proxy_pass http://backend:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 120s;  # allow long-running image generation responses
            proxy_connect_timeout 10s;
        }

        # React Router — serve index.html for all non-API routes (SPA fallback)
        location / {
            try_files $uri $uri/ /index.html;
        }
    }
}
```

**`backend/.env.example`** — Document all required environment variables. This file is committed to git; actual `.env` is gitignored.

Note on uptime monitoring (per CONTEXT.md locked decision — Sentry for errors + UptimeRobot for uptime alerts):
After deploying, register a free UptimeRobot monitor at uptimerobot.com:
  1. Add New Monitor → HTTP(s)
  2. URL: https://your-domain/health
  3. Monitoring interval: 5 minutes
  4. Alert contact: your email
No environment variable is needed — UptimeRobot is configured entirely in its dashboard.

```bash
# ============================================================
# Ava Backend — Environment Variables
# Copy this file to .env and fill in real values.
# NEVER commit .env to git.
# ============================================================

# --- Supabase (required) ---
# Get from: Supabase Dashboard -> Settings -> API
SUPABASE_URL=https://your-project-id.supabase.co
SUPABASE_ANON_KEY=eyJ...your-anon-key
SUPABASE_SERVICE_ROLE_KEY=eyJ...your-service-role-key

# --- OpenAI (required for chat + intent classification) ---
# Get from: platform.openai.com -> API keys
OPENAI_API_KEY=sk-...

# --- Replicate (required for image generation) ---
# Get from: replicate.com -> Account -> API tokens
REPLICATE_API_TOKEN=r8_...

# --- Stripe (required for billing) ---
# Get from: Stripe Dashboard -> Developers -> API keys
STRIPE_SECRET_KEY=sk_live_...   # use sk_test_... for development
# Get from: Stripe Dashboard -> Developers -> Webhooks -> signing secret
STRIPE_WEBHOOK_SECRET=whsec_...
# Get from: Stripe Dashboard -> Products -> your monthly product -> Price ID
STRIPE_PRICE_ID=price_...

# --- Sentry (optional — leave empty to disable in dev) ---
# Get from: sentry.io -> Project -> Settings -> Client Keys (DSN)
SENTRY_DSN=https://your-dsn@o123456.ingest.sentry.io/123456

# --- UptimeRobot (no env var needed — configured in dashboard only) ---
# After deploy: register at uptimerobot.com -> Add Monitor -> HTTP(s)
# URL: https://your-domain/health  |  Interval: 5 min  |  Alert: your email
# See: uptimerobot.com

# --- WhatsApp (optional — required for WhatsApp delivery) ---
# Get from: Meta Developer Console -> App -> WhatsApp -> API Setup
WHATSAPP_ACCESS_TOKEN=
WHATSAPP_PHONE_NUMBER_ID=
WHATSAPP_VERIFY_TOKEN=

# --- Google OAuth (optional — required for Calendar skill) ---
GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=
GOOGLE_OAUTH_REDIRECT_URI=https://your-domain/auth/google/callback

# --- Tavily (optional — required for Research skill) ---
TAVILY_API_KEY=

# --- App config ---
APP_ENV=production          # "development" or "production"
FRONTEND_URL=https://your-domain.com
LLM_PROVIDER=openai
LLM_MODEL=gpt-4.1-mini

# --- Redis (set automatically by Docker Compose — override for external Redis) ---
REDIS_URL=redis://redis:6379
```
  </action>
  <verify>
    <automated>cd "C:/Users/raphg/Desktop/IA/ava2" && python -c "import yaml; yaml.safe_load(open('docker-compose.yml'))" 2>/dev/null || node -e "require('fs').readFileSync('docker-compose.yml'); console.log('docker-compose.yml readable')" 2>&1 | head -5</automated>
    <manual>Verify: `grep "worker_main" docker-compose.yml` — found. `grep "STRIPE_SECRET_KEY" backend/.env.example` — found. `grep "UptimeRobot" backend/.env.example` — found. `grep "proxy_pass" nginx.conf` — found.</manual>
    <sampling_rate>run after task 2</sampling_rate>
  </verify>
  <done>
    docker-compose.yml with 4 services (nginx, backend, worker, redis). nginx.conf proxies all API paths to backend:8000, serves frontend SPA with try_files fallback. backend/.env.example documents all env vars including all Phase 7 additions. UptimeRobot setup instructions documented in .env.example comment (no env var needed — dashboard-only setup). redis has AOF persistence. worker runs python worker_main.py.
  </done>
</task>

</tasks>

<verification>
- `cd frontend && npm run build 2>&1 | tail -3` — zero TypeScript errors
- `grep "sentry_sdk.init" backend/app/main.py` — found
- `grep "sentry-sdk" backend/requirements.txt` — found
- `grep "worker_main" docker-compose.yml` — found
- `grep "STRIPE_SECRET_KEY" backend/.env.example` — found
- `grep "REPLICATE_API_TOKEN" backend/.env.example` — found
- `grep "UptimeRobot" backend/.env.example` — found
- `grep "proxy_pass" nginx.conf` — found
- `cd backend && python -m pytest tests/ -x -q 2>&1 | tail -3` — all tests pass
</verification>

<success_criteria>
1. SubscribePage: Subscribe button → POST /billing/checkout → window.location.href to Stripe Checkout URL
2. Cancelled checkout: /subscribe?cancelled=1 shows feedback message
3. ChatPage: 402 response from POST /chat shows yellow paywall banner with /subscribe link
4. Sentry: sentry_sdk.init(dsn=settings.sentry_dsn) in main.py before FastAPI(); empty DSN = disabled
5. Docker Compose: nginx + backend + worker + redis services; worker runs python worker_main.py; redis has AOF persistence
6. nginx.conf: proxies /auth /chat /billing /avatars /preferences /photos /webhook to backend:8000; serves SPA
7. .env.example: documents all env vars including STRIPE_SECRET_KEY, STRIPE_PRICE_ID, REPLICATE_API_TOKEN, SENTRY_DSN
8. .env.example: includes UptimeRobot setup instructions (dashboard-only — no env var needed; per CONTEXT.md locked decision)
</success_criteria>

<output>
After completion, create `.planning/phases/07-avatar-system-production/07-05-SUMMARY.md`
</output>
