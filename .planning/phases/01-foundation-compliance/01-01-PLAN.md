---
phase: 01-foundation-compliance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - compliance/audit-schema/schema.sql
  - compliance/audit-schema/indexes.sql
  - compliance/audit-schema/migration-001.sql
  - compliance/policies/takedown-process.md
autonomous: true
requirements: [SAFE-03, ARCH-04]

must_haves:
  truths:
    - "Audit log schema exists and can be applied to a PostgreSQL database without errors"
    - "Audit logs are append-only (UPDATE/DELETE triggers prevent modification)"
    - "Takedown process is documented with 48-hour timeline and clear steps"
    - "Takedown request table schema exists for tracking requests"
  artifacts:
    - path: "compliance/audit-schema/schema.sql"
      provides: "Core audit_log table with JSONB event_data, takedown_requests table"
      contains: "CREATE TABLE audit_log"
    - path: "compliance/audit-schema/indexes.sql"
      provides: "Performance indexes for compliance queries"
      contains: "CREATE INDEX"
    - path: "compliance/audit-schema/migration-001.sql"
      provides: "Combined migration file that applies schema + indexes + triggers"
      contains: "CREATE TABLE"
    - path: "compliance/policies/takedown-process.md"
      provides: "48-hour takedown process documentation"
      contains: "48"
  key_links:
    - from: "compliance/audit-schema/migration-001.sql"
      to: "compliance/audit-schema/schema.sql"
      via: "migration includes schema creation"
      pattern: "audit_log"
---

<objective>
Create the audit log database schema and takedown process documentation that form the compliance infrastructure foundation.

Purpose: All future compliance work (content moderation logging, age verification logging, account deletion tracking) depends on a well-designed audit schema. The takedown process documentation satisfies SAFE-03 and provides a ready-to-implement process for edge cases.

Output: SQL schema files for audit_log and takedown_requests tables, performance indexes, append-only trigger protection, and a complete takedown process document.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-compliance/1-CONTEXT.md
@.planning/phases/01-foundation-compliance/1-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create audit log and takedown request database schemas</name>
  <files>compliance/audit-schema/schema.sql, compliance/audit-schema/indexes.sql, compliance/audit-schema/migration-001.sql</files>
  <action>
Create the compliance/audit-schema/ directory and three SQL files:

**schema.sql** — Core tables:
1. `audit_log` table with columns: id (UUID PK, gen_random_uuid()), event_time (TIMESTAMPTZ NOT NULL DEFAULT NOW()), user_id (UUID NOT NULL), event_type (VARCHAR(50) NOT NULL), event_category (VARCHAR(20) NOT NULL — values: 'auth', 'content', 'moderation', 'account'), action (VARCHAR(20) NOT NULL — values: 'create', 'read', 'update', 'delete', 'verify', 'block'), resource_type (VARCHAR(50) nullable), resource_id (UUID nullable), event_data (JSONB NOT NULL DEFAULT '{}'), ip_address (INET nullable), user_agent (TEXT nullable), session_id (UUID nullable), result (VARCHAR(20) NOT NULL — values: 'success', 'failure', 'blocked'), error_message (TEXT nullable).
2. `takedown_requests` table with columns: id (UUID PK, gen_random_uuid()), request_time (TIMESTAMPTZ NOT NULL DEFAULT NOW()), requestor_email (VARCHAR(255) NOT NULL), requestor_name (VARCHAR(255) nullable), content_url (TEXT NOT NULL), content_id (UUID nullable), reason (TEXT NOT NULL), status (VARCHAR(20) NOT NULL — values: 'received', 'reviewing', 'completed', 'rejected'), action_taken (VARCHAR(50) nullable), reviewer_id (UUID nullable), reviewed_at (TIMESTAMPTZ nullable), notes (TEXT nullable).
3. Append-only trigger: Create function `protect_audit_log()` that raises exception 'Direct modification of audit_log is forbidden'. Attach as BEFORE UPDATE OR DELETE trigger on audit_log.

**indexes.sql** — Performance indexes for audit_log:
- idx_audit_log_event_time (event_time DESC)
- idx_audit_log_user_id (user_id)
- idx_audit_log_event_type (event_type)
- idx_audit_log_category (event_category)
- idx_audit_log_resource (resource_type, resource_id)
- idx_audit_log_event_data_gin USING GIN (event_data)
- idx_audit_log_user_time (user_id, event_time DESC) — composite for common compliance queries
- idx_takedown_requests_status (status)
- idx_takedown_requests_request_time (request_time DESC)

**migration-001.sql** — Single migration file that sources schema.sql content then indexes.sql content (copy both into one file with clear section comments), wrapped in a transaction (BEGIN/COMMIT). Add header comment with migration number, date, and description.

Do NOT include table partitioning (premature for Phase 1 — no data volume yet).
Do NOT log IP addresses or timestamps for age verification per user decision (data minimization).
  </action>
  <verify>
    <automated>cd C:/Users/raphg/Desktop/IA/ava2 && test -f compliance/audit-schema/schema.sql && test -f compliance/audit-schema/indexes.sql && test -f compliance/audit-schema/migration-001.sql && grep -q "CREATE TABLE audit_log" compliance/audit-schema/schema.sql && grep -q "CREATE TABLE takedown_requests" compliance/audit-schema/schema.sql && grep -q "protect_audit_log" compliance/audit-schema/schema.sql && grep -q "CREATE INDEX" compliance/audit-schema/indexes.sql && grep -q "BEGIN" compliance/audit-schema/migration-001.sql && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>Three SQL files exist. audit_log table has all required columns with JSONB event_data. takedown_requests table has all required columns. Append-only trigger prevents UPDATE/DELETE on audit_log. Indexes cover event_time, user_id, event_type, category, resource, and GIN on event_data. Migration file wraps everything in a transaction.</done>
</task>

<task type="auto">
  <name>Task 2: Create takedown process documentation</name>
  <files>compliance/policies/takedown-process.md</files>
  <action>
Create compliance/policies/ directory and takedown-process.md with the following sections:

1. **Scope** — Clarify this process applies to requests for removal of AI-generated images that allegedly depict an identifiable real person without consent (deepfake), violate IP rights, or contain illegal content. Include explicit note: "TAKE IT DOWN Act applies to deepfakes of real, identifiable people. Ava generates fictional characters from user descriptions — this process exists for edge cases (e.g., user uploads real person's photo as avatar reference)."

2. **Timeline** — Acknowledgment within 24 hours, review and action within 48 hours of acknowledgment (72 hours total from request receipt).

3. **Request Requirements** — List 6 items: requestor identity (name, email, phone), proof of identity for depicted individual, content identification (URL or image ID), statement of non-consent, good faith statement, signature. Include submission email: takedown@ava-platform.com (placeholder).

4. **Review Process** — Four steps:
   - Step 1 (Acknowledgment, 24h): Log request, send ack email with case ID, assign reviewer.
   - Step 2 (Validation, 48h): Verify requestor identity, confirm content exists, determine validity (real person depicted = valid, fictional character = invalid).
   - Step 3 (Action, 48h): If valid — remove from storage, purge CDN, revoke URLs, log removal, notify requestor. If invalid — send explanation, offer alternative.
   - Step 4 (Counter-Notice, optional): Creator can submit counter-notice, reviewed within 10 business days, restore if valid.

5. **Audit Trail** — Reference audit_log event_types: takedown_request_received, takedown_review_completed, takedown_content_removed.

6. **Escalation** — If law enforcement request, escalate to legal counsel immediately. Do not delay response while awaiting legal advice.

Use clear Markdown formatting with headers, numbered lists, and a table for the timeline summary.
  </action>
  <verify>
    <automated>cd C:/Users/raphg/Desktop/IA/ava2 && test -f compliance/policies/takedown-process.md && grep -q "48" compliance/policies/takedown-process.md && grep -q "TAKE IT DOWN" compliance/policies/takedown-process.md && grep -q "fictional" compliance/policies/takedown-process.md && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>Takedown process document exists with: scope clarifying TAKE IT DOWN Act applicability to fictional characters, 24/48-hour timeline, 6-item request requirements, 4-step review process, audit trail references, and escalation procedure.</done>
</task>

</tasks>

<verification>
- All 3 SQL files exist in compliance/audit-schema/
- Takedown process document exists in compliance/policies/
- audit_log table has UUID PK, TIMESTAMPTZ event_time, JSONB event_data, and all specified columns
- Append-only trigger prevents modification of audit records
- Migration file is wrapped in BEGIN/COMMIT transaction
- Takedown process covers 48-hour timeline with clear steps
</verification>

<success_criteria>
- Schema SQL files can be reviewed and are syntactically valid PostgreSQL
- Audit log schema supports all event types needed for compliance (age verification, content blocks, image generation, account deletion, takedown requests)
- Takedown process documentation is complete and actionable
- No PII storage beyond user_id in audit logs (per user decision on data minimization)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-compliance/01-01-SUMMARY.md`
</output>
